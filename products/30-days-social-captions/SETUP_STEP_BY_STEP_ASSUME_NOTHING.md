# 30 Days Captions — Setup Step by Step (Assume You Know Nothing)

**Can someone else do this for you?** Most of it has to be you. Nobody else can log into your Stripe, Supabase, SendGrid, or OpenAI accounts, or paste your API keys into your `.env`. The code and database schema are already in your project; this guide tells you the clicks and copy-pastes. When you’re done, run `python check_captions_setup.py` from the project root to confirm your env and (optionally) the database table are set.

---

This guide gets the **automated** 30 Days Captions offer live. After you finish:

1. A customer pays £97 on your site.
2. They get an email with a link to a short form.
3. They fill the form and submit.
4. Your system generates 30 captions and emails them the file. You do nothing by hand.

You need to do the steps below **in order**. Each step tells you what it does and why.

---

## Before you start: what you need

- **A Stripe account** (free). Stripe is what takes the payment. Sign up at [stripe.com](https://stripe.com).
- **A Supabase account** (free tier is fine). Supabase is the database where we store each order. Sign up at [supabase.com](https://supabase.com).
- **A SendGrid account** (free tier is fine). SendGrid sends the emails (intake link + delivery). Sign up at [sendgrid.com](https://sendgrid.com).
- **An OpenAI API key.** The captions are generated by OpenAI. You get a key at [platform.openai.com](https://platform.openai.com) (you pay per use, a few pence per order).
- **Your site running somewhere** so Stripe can send a “payment happened” message to your site, and customers can open the form and thank-you page. For example: your domain (e.g. lumo22.com) or a test URL (e.g. ngrok) while you test.

Replace **yourdomain.com** in this guide with your real site URL (no `https://` in some places, see below).

---

## Step 1: Create the database table (Supabase)

**What it does:** Creates a table where each 30 Days Captions order is stored (customer email, form answers, generated captions, status).

**What to do:**

1. Log in to [Supabase](https://supabase.com) and open your project (or create one).
2. In the left sidebar, click **SQL Editor**.
3. Click **New query**.
4. Copy and paste the entire block below into the editor, then click **Run** (or press Cmd/Ctrl + Enter).

```sql
CREATE TABLE IF NOT EXISTS caption_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    token TEXT NOT NULL UNIQUE,
    customer_email TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'awaiting_intake',
    stripe_session_id TEXT,
    intake JSONB,
    captions_md TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_caption_orders_token ON caption_orders(token);
CREATE INDEX IF NOT EXISTS idx_caption_orders_status ON caption_orders(status);
CREATE INDEX IF NOT EXISTS idx_caption_orders_created_at ON caption_orders(created_at DESC);
```

5. You should see a success message. The table `caption_orders` now exists.

---

## Step 2: Create the product and payment link in Stripe

**What it does:** So customers can pay £97 for 30 Days Captions. The “payment link” is the URL you’ll put on your site (e.g. “Get my 30 days” button).

**What to do:**

1. Log in to [Stripe Dashboard](https://dashboard.stripe.com).
2. In the left sidebar, click **Product catalog** (or **Products**).
3. Click **Add product**.
4. Fill in:
   - **Name:** `30 Days of Social Media Captions`
   - **Description:** (optional) e.g. `30 done-for-you captions tailored to your brand.`
   - **Pricing:** choose **One time**, amount **£97** (or your currency and price).
5. Click **Save product**.
6. On the product page, click the **⋯** (three dots) and choose **Create payment link** (or go to **Payment links** in the sidebar → **Create link** and select this product).
7. On the payment link settings:
   - Under **After payment**, find **Redirect URL** (or “Confirmation page”) and set it to:  
     `https://yourdomain.com/captions-thank-you`  
     (Use your real domain, e.g. `https://lumo22.com/captions-thank-you`.)
8. Click **Create link** (or **Save**).
9. **Copy the link** (it looks like `https://buy.stripe.com/xxxxx`). You’ll paste it into your `.env` file in Step 5.

---

## Step 3: Add a webhook in Stripe

**What it does:** When someone pays, Stripe sends a message to your site. Your site then creates the order and emails the customer the intake form link. The “webhook” is Stripe’s way of calling a URL on your server when an event (e.g. “payment completed”) happens.

**What to do:**

1. In Stripe, left sidebar, click **Developers** → **Webhooks**.
2. Click **Add endpoint**.
3. **Endpoint URL:** type your site URL plus the path Stripe should call:  
   `https://yourdomain.com/webhooks/stripe`  
   (Example: `https://lumo22.com/webhooks/stripe`. No slash at the end.)
4. **Events to send:** click **Select events**, then choose **checkout.session.completed**. Click **Add endpoint**.
5. After the endpoint is created, click it to open its details. Find **Signing secret** and click **Reveal** (or **Click to reveal**).
6. **Copy the signing secret** (it starts with `whsec_`). You’ll paste it into your `.env` file in Step 5.

**Important:** Your site must be live and reachable at that URL (e.g. deployed, or exposed with ngrok) for Stripe to call it. If you’re only testing locally, use an ngrok URL here and in `BASE_URL` (see Step 5).

---

## Step 4: Get your other keys and URLs

You’ll need these for Step 5. Collect them in a note:

| What | Where to get it |
|------|------------------|
| **Supabase URL** | Supabase → Project Settings → API → Project URL |
| **Supabase anon key** | Supabase → Project Settings → API → Project API keys → `anon` `public` |
| **SendGrid API key** | SendGrid → Settings → API Keys → Create API Key (full access or “Mail Send”) |
| **From email** | The address you want emails to come *from* (e.g. `hello@lumo22.com`). Must be verified in SendGrid (Sender Authentication). |
| **OpenAI API key** | platform.openai.com → API keys → Create new secret key |
| **Your site base URL** | The full URL of your site with no trailing slash, e.g. `https://lumo22.com` or `https://xxxx.ngrok.io` |

---

## Step 5: Fill in your `.env` file

**What it does:** Your app reads settings (API keys, URLs) from a file called `.env` in the project root. Without the right values here, payment, emails, and caption generation won’t work.

**What to do:**

1. In your project folder (where `app.py` and `requirements.txt` live), open the file named **`.env`**.  
   - If it doesn’t exist, copy **`.env.example`** and rename the copy to **`.env`**.
2. Add or edit these lines. Use your **real** values (no quotes needed; replace the placeholders).

```env
# 30 Days Captions — payment link from Step 2
CAPTIONS_PAYMENT_LINK=https://buy.stripe.com/xxxxx

# Stripe webhook — signing secret from Step 3
STRIPE_WEBHOOK_SECRET=whsec_xxxxx

# Your site (no trailing slash). Stripe and emails use this.
BASE_URL=https://yourdomain.com

# Database (from Step 4)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key-here

# Emails (from Step 4)
SENDGRID_API_KEY=SG.xxxxx
FROM_EMAIL=hello@lumo22.com

# Caption generation (from Step 4)
OPENAI_API_KEY=sk-xxxxx
```

3. Save the file.

**Check:** `CAPTIONS_PAYMENT_LINK` must be the link you copied in Step 2. `STRIPE_WEBHOOK_SECRET` must be the secret from Step 3. `BASE_URL` must be exactly the URL where your site is live (same as in the Stripe webhook URL), with no slash at the end.

---

## Step 6: Run (or deploy) your site

**What it does:** Your app must be running and reachable at `BASE_URL` so that:  
- Customers can open `/captions`, `/captions-intake`, and `/captions-thank-you`  
- Stripe can send the “payment completed” event to `https://yourdomain.com/webhooks/stripe`

**What to do:**

- **On your own computer:** In the project folder, run your app as you usually do (e.g. `python app.py` or `flask run`). Then either:
  - Deploy the same code to a host (e.g. Railway, Render, Fly) and use that URL as `BASE_URL` and in Stripe, or  
  - For local testing only: use [ngrok](https://ngrok.com) to expose your local server, and set `BASE_URL` and the Stripe webhook URL to the ngrok URL (e.g. `https://abc123.ngrok.io`).
- **On a server/host:** Deploy the app, set `BASE_URL` and all keys in the host’s environment (or in `.env` there), then restart the app.

After you change `.env` or any env vars, **restart the app** so it picks them up.

---

## Step 7: Test the full flow

**What it does:** Confirms that payment → email → form → generation → delivery email all work.

**What to do:**

1. **Use Stripe test mode** (toggle “Test mode” in the Stripe dashboard so you don’t charge a real card).
2. Put your **test** payment link in `.env` as `CAPTIONS_PAYMENT_LINK` (create a test payment link in Stripe if you only had a live one).
3. Open your product page (e.g. `https://yourdomain.com/captions`) and click **Get my 30 days**. Complete checkout with Stripe’s test card (e.g. `4242 4242 4242 4242`).
4. You should land on **Thank you for your order** and receive an **email** with a link like `https://yourdomain.com/captions-intake?t=xxxxx`.
5. Open that link, fill in the intake form, and click **Send my answers**.
6. Within a few minutes you should get a **second email** with an attachment: **30_Days_Captions.md** (your 30 captions).

If anything doesn’t happen (no intake email, no delivery email, form says “Invalid link”), see **When something goes wrong** below.

---

## When something goes wrong

| What you see | What to check |
|--------------|----------------|
| No email after payment | Stripe webhook URL is correct and your site is reachable there. `STRIPE_WEBHOOK_SECRET` and `SENDGRID_API_KEY` / `FROM_EMAIL` are set in `.env`. In Stripe → Developers → Webhooks, open your endpoint and check “Recent deliveries” for errors. |
| Intake form says “Invalid or expired link” | You must open the **exact** link from the email (with `?t=...`). If you opened `/captions-intake` without `?t=`, the form won’t know which order to use. |
| No delivery email after submitting the form | Check your app logs for errors (OpenAI or SendGrid). In Supabase, open the `caption_orders` table and see if that order’s `status` is `failed`. Fix the cause (e.g. wrong API key, rate limit). |
| Stripe webhook returns “Invalid signature” | `STRIPE_WEBHOOK_SECRET` must be the **signing secret** from the webhook’s page (starts with `whsec_`), not your Stripe API key. |
| “Service unavailable” or 503 on intake | Supabase or SendGrid isn’t configured. Check `SUPABASE_URL`, `SUPABASE_KEY`, and that the `caption_orders` table exists (Step 1). |

---

## Quick checklist

- [ ] Step 1: Supabase table `caption_orders` created (SQL run in SQL Editor).
- [ ] Step 2: Stripe product and payment link created; redirect URL set to `/captions-thank-you`; link copied into `.env` as `CAPTIONS_PAYMENT_LINK`.
- [ ] Step 3: Stripe webhook added; URL is `https://yourdomain.com/webhooks/stripe`; event `checkout.session.completed`; signing secret copied into `.env` as `STRIPE_WEBHOOK_SECRET`.
- [ ] Step 4: Supabase URL/key, SendGrid key, From email, OpenAI key, and base URL collected.
- [ ] Step 5: `.env` updated with all of the above (no trailing slash on `BASE_URL`).
- [ ] Step 6: App run or deployed and restarted after env changes; site reachable at `BASE_URL`.
- [ ] Step 7: Test payment → intake email → form submit → delivery email with attachment.

When all boxes are done, the 30 Days Captions offer is live and automated.
