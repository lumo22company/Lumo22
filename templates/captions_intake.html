<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>30 Days Captions — Your details | Lumo 22</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <meta name="description" content="Complete the form so we can tailor your 30 days of social media captions for feed posts, Reels, and more.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans+Condensed:wght@400;500;600;700&family=Inter+Tight:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}?v={{ asset_version }}">
  <style>
    .intake-page {
      padding: 2rem 1.5rem 4rem;
      max-width: 560px;
      margin: 6rem auto 4rem;
      background: var(--bg-light);
      color: #1a1a1a;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    }
    .intake-page h1 { font-family: 'Encode Sans Condensed', sans-serif; font-size: 1.75rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem; color: #000; }
    .intake-page .sub { color: #555; margin-bottom: 2.5rem; }
    .intake-page label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; color: #1a1a1a; }
    .intake-page input, .intake-page textarea {
      width: 100%; padding: 0.75rem 1rem;
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      color: #111; font-family: var(--font-body); font-size: 1rem; margin-bottom: 1.25rem;
    }
    .intake-page input:focus, .intake-page textarea:focus { outline: none; border-color: #666; }
    .intake-page textarea { min-height: 100px; resize: vertical; }
    .intake-page input::placeholder, .intake-page textarea::placeholder { color: #666; }
    .intake-page .form-section { margin-bottom: 2rem; }
    .intake-page .form-section h2 { font-family: 'Encode Sans Condensed', sans-serif; font-size: 1.1rem; color: #555; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .intake-page .btn-submit {
      display: inline-block; padding: 1rem 2rem;
      background: var(--lum-gold); color: #000;
      text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; border: none; cursor: pointer; font-family: var(--font-display);
    }
    .intake-page .btn-submit:hover { opacity: 0.95; }
    .intake-page .back { margin-top: 2rem; }
    .intake-page .back a { color: #555; text-decoration: none; font-size: 0.95rem; }
    .intake-page .back a:hover { color: #000; }
    .intake-page .intake-back-account { font-weight: 600; color: #000; }
    .intake-page .intake-back-account:hover { color: var(--lum-gold); }
    .intake-page a[href] { color: #1a1a1a; }
    .intake-page a[href]:hover { color: #000; text-decoration: underline; }
    .intake-page .review-step { display: none; margin-bottom: 2rem; }
    .intake-page .review-step.show { display: block; }
    .intake-page .review-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #ddd; }
    .intake-page .review-section:last-of-type { border-bottom: none; }
    .intake-page #review-content { min-height: 70vh; }
    .intake-page .review-section h3 { font-size: 0.85rem; color: #555; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .intake-page .review-section p { margin: 0; font-size: 0.95rem; line-height: 1.5; color: #1a1a1a; white-space: pre-wrap; }
    .intake-page .review-section .empty { color: #666; font-style: italic; }
    .intake-page .review-actions { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; }
    .intake-page .btn-secondary { background: transparent; color: #333; border: 1px solid #999; }
    .intake-page .btn-secondary:hover { border-color: #666; color: #000; }
    .intake-page .help-trigger { display: inline-flex; align-items: center; justify-content: center; width: 1.1rem; height: 1.1rem; border-radius: 50%; background: #999; color: #fff; font-size: 0.7rem; font-weight: 600; cursor: help; margin-left: 0.4rem; vertical-align: middle; position: relative; }
    .intake-page .help-trigger:hover, .intake-page .help-trigger:focus { background: var(--lum-gold); color: #000; outline: none; }
    .intake-page .help-tooltip { position: absolute; left: 50%; transform: translateX(-50%); bottom: calc(100% + 0.5rem); width: min(280px, 90vw); padding: 1rem; background: #1a1a1a; color: #f5f5f2; font-size: 0.8rem; line-height: 1.5; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 1px solid #333; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 100; pointer-events: none; text-align: left; font-weight: 400; }
    .intake-page .help-trigger:hover .help-tooltip, .intake-page .help-trigger:focus .help-tooltip { opacity: 1; visibility: visible; }
    .intake-page .help-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border: 6px solid transparent; border-top-color: #1a1a1a; }
    .intake-page .field-helper { font-size: 0.85rem; color: #555; margin: -0.75rem 0 1rem; line-height: 1.4; }
    .intake-page #intake-success .btn-submit { background: var(--lum-gold); color: #000; }
    .intake-page #intake-success div[style*="background"] { background: #f0f0ee !important; border: 1px solid #ddd; }
    .intake-page #intake-error { background: rgba(200,80,80,0.12); color: #1a1a1a; border: 1px solid rgba(200,80,80,0.3); }
    .intake-page select { width: 100%; padding: 0.75rem 1rem; background: #fff; border: 1px solid #ccc; border-radius: 8px; color: #111; font-family: var(--font-body); font-size: 1rem; margin-bottom: 1.25rem; }
    .intake-page select:focus { outline: none; border-color: #666; }
    .intake-checkbox-group { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; margin-bottom: 0.25rem; }
    .platform-btn { padding: 0.5rem 1rem; border: 1px solid #ccc; border-radius: 8px; background: #fff; font-size: 0.95rem; cursor: pointer; font-family: inherit; color: #1a1a1a; }
    .platform-btn:hover:not(:disabled) { border-color: #888; }
    .platform-btn.selected { background: var(--lum-gold, #c9a227); border-color: var(--lum-gold, #c9a227); color: #000; }
    .platform-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .intake-checkbox-label { display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 400; font-size: 0.95rem; }
    .intake-checkbox-label input { width: auto; margin: 0; }
    .intake-checkbox-label input:disabled { cursor: not-allowed; opacity: 0.5; }
    .intake-checkbox-label:has(input:disabled) { cursor: not-allowed; color: #888; pointer-events: none; }
  </style>
</head>
<body class="lumo-landing" data-current-customer-email="{{ (current_customer.email or '')|lower if current_customer else '' }}">
  <nav class="lumo-nav lumo-nav-scrolled">
    <a href="/" class="lumo-nav-logo">Lumo 22</a>
    <div class="lumo-nav-links">
      <a href="/captions">Captions</a>
    </div>
    <a href="/captions" class="lumo-nav-cta">Get my 30 days</a>
  </nav>

  <main class="intake-page">
    <!-- intake-form-version: 2025-02-v3 -->
    <h1>30 DAYS CAPTIONS — YOUR DETAILS</h1>
    <p class="sub">Complete this form so we can tailor your caption set. Your answers shape your voice and structure for the month.</p>

    {% if not intake_token %}
    <p class="sub" style="margin-top: 1rem;">Use the link from your order email to complete the form. If you just purchased, check your inbox for a message from us with a personalised link.</p>
    <p class="sub" style="margin-top: 0.5rem;">Haven't bought yet? <a href="/captions" style="color: var(--lum-gold);">Get 30 Days Captions</a></p>
    <p class="back" style="margin-bottom: 1rem;">
      <a href="/account/edit-form" class="intake-back-account">← Back to your account</a>
      <span style="color: #999; margin: 0 0.5rem;">|</span>
      <a href="/captions">30 Days Captions</a>
    </p>
    {% else %}
    <div id="intake-success" style="display: none; margin: 2rem 0;">
      <div style="padding: 1.5rem; background: var(--lum-surface-elevated); border-radius: 8px; margin-bottom: 1rem;">
        <p id="intake-success-msg" style="margin: 0;">Request received. We'll take it from here — your captions will arrive by email within a few minutes.</p>
      </div>
      <div id="create-account-box" style="padding: 1.25rem; background: var(--lum-surface-elevated); border-radius: 8px; border: 1px solid var(--lum-border);">
        <div id="ca-create-state">
          <p style="margin: 0 0 1rem; font-weight: 500;">Create an account to access your captions and more in one place.</p>
          <p id="ca-required-note" style="margin: 0 0 1rem; font-size: 0.85rem; color: var(--lum-text-muted); display: none;">Required for subscription customers — you'll use this to manage billing and re-download captions.</p>
          <p id="ca-email-display" style="margin: 0 0 0.75rem; font-size: 0.9rem; color: var(--lum-text-muted); display: none;">Account for: <strong id="ca-email-text"></strong></p>
          <form id="create-account-form" style="max-width: 320px;">
            <input type="hidden" id="ca-email" value="">
            <label for="ca-password" style="display:block; font-size:0.9rem; margin-bottom:0.25rem;">Password (min 6 characters)</label>
            <input type="password" id="ca-password" required minlength="6" style="width:100%; padding:0.5rem 0.75rem; margin-bottom:0.75rem; border-radius:6px; border:1px solid var(--lum-border);">
            <button type="submit" class="btn-submit" id="ca-btn">Create account</button>
          </form>
        </div>
        <p id="ca-done" style="display:none; margin:0; color: var(--lum-gold);">Account created! <a href="/account" style="color:inherit;">Go to your account</a></p>
        <p id="ca-already-logged-in" style="display:none; margin:0; font-weight: 500;">You're logged in. <a href="/account" style="color: var(--lum-gold);">Go to your account</a></p>
        <p id="ca-already-has-account" style="display:none; margin:0; font-weight: 500;">You already have an account. <a href="/login" style="color: var(--lum-gold);">Log in</a></p>
      </div>
    </div>
    <div id="intake-error" style="display: none; margin: 2rem 0; padding: 1.5rem; background: rgba(200,80,80,0.15); border-radius: 8px; color: var(--lum-text);"></div>

    <form id="captions-intake-form" action="#" method="post" data-platforms-count="{{ platforms_count }}">
      <input type="hidden" name="token" id="intake_token" value="{{ intake_token }}">
      <div class="form-section">
        <h2>Business</h2>
        <label for="business_name">What is your business name? <span style="color:#999;">(required)</span></label>
        <input type="text" id="business_name" name="business_name" required placeholder="e.g. Lumo 22, Acme Coaching" value="{{ existing_intake.get('business_name', '') }}">
        <label for="business_type">What type of business do you run?</label>
        <select id="business_type" name="business_type">
          <option value="">— Select one —</option>
          <option value="Consultancy" {% if existing_intake.get('business_type') == 'Consultancy' %}selected{% endif %}>Consultancy</option>
          <option value="Agency" {% if existing_intake.get('business_type') == 'Agency' %}selected{% endif %}>Agency</option>
          <option value="Coach / Mentor" {% if existing_intake.get('business_type') == 'Coach / Mentor' %}selected{% endif %}>Coach / Mentor</option>
          <option value="Product brand / E-commerce" {% if existing_intake.get('business_type') in ['Product brand / E-commerce', 'Product brand', 'E-commerce'] %}selected{% endif %}>Product brand / E-commerce</option>
          <option value="Service business" {% if existing_intake.get('business_type') == 'Service business' %}selected{% endif %}>Service business</option>
          <option value="Creative / Freelancer" {% if existing_intake.get('business_type') == 'Creative / Freelancer' %}selected{% endif %}>Creative / Freelancer</option>
          <option value="Other" {% if existing_intake.get('business_type') and existing_intake.get('business_type') not in ['Consultancy', 'Agency', 'Coach / Mentor', 'Product brand / E-commerce', 'Product brand', 'E-commerce', 'Service business', 'Creative / Freelancer'] %}selected{% endif %}>Other</option>
        </select>
        <input type="text" id="business_type_other" name="business_type_other" placeholder="Specify your business type" class="intake-other-field" style="display: none; margin-top: 0.5rem;" value="{{ existing_intake.get('business_type', '') if existing_intake.get('business_type') and existing_intake.get('business_type') not in ['Consultancy', 'Agency', 'Coach / Mentor', 'Product brand / E-commerce', 'Product brand', 'E-commerce', 'Service business', 'Creative / Freelancer'] else '' }}">
        <label for="offer_one_line">In one sentence, what do you offer and to whom?</label>
        <textarea id="offer_one_line" name="offer_one_line" placeholder="e.g. We help busy founders build a content habit without the daily grind">{{ existing_intake.get('offer_one_line', '') }}</textarea>
        <p class="field-helper">A couple of sentences is enough.</p>
      </div>
      <div class="form-section">
        <h2>Audience</h2>
        <p class="field-helper" style="margin-bottom: 0.5rem;">Who is your primary audience? (pick any that apply)</p>
        <div class="intake-checkbox-group" role="group" aria-label="Primary audience">
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Founders"> Founders</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Small business owners"> Small business owners</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Marketing leads"> Marketing leads</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Creatives"> Creatives</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Consumers" id="audience_cb_consumers"> Consumers</label>
        </div>
        <div id="consumer_age_wrap" class="intake-other-wrap" style="display: none; margin-top: 0.75rem;" data-consumer-age-field="true">
          <label for="consumer_age_range">What age range is your consumer audience?</label>
          <input type="text" id="consumer_age_range" name="consumer_age_range" placeholder="e.g. 18-24 or 30+" value="{{ existing_intake.get('consumer_age_range', '') }}" autocomplete="off">
        </div>
        <input type="text" id="audience_other" name="audience_other" placeholder="Other (e.g. coaches, agencies)" style="margin-top: 0.75rem;" value="">
        <input type="hidden" id="audience" name="audience" value="{{ existing_intake.get('audience', '') }}">
        <label for="audience_cares">What do they care about most when they land on your content?</label>
        <textarea id="audience_cares" name="audience_cares" placeholder="e.g. quick wins, feeling less overwhelmed, practical tips">{{ existing_intake.get('audience_cares', '') }}</textarea>
      </div>
      <div class="form-section">
        <h2>Voice</h2>
        <p class="field-helper" style="margin-bottom: 0.5rem;">Choose 3–5 words that describe how you want to sound (pick any that apply):</p>
        <div class="intake-checkbox-group" role="group" aria-label="Voice tone">
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="direct"> Direct</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="thoughtful"> Thoughtful</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="warm"> Warm</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="professional"> Professional</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="playful"> Playful</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="understated"> Understated</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="bold"> Bold</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="friendly"> Friendly</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="concise"> Concise</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="inspiring"> Inspiring</label>
        </div>
        <input type="text" id="voice_words_other" name="voice_words_other" placeholder="Other words (optional)" style="margin-top: 0.75rem;" value="">
        <input type="hidden" id="voice_words" name="voice_words" value="{{ existing_intake.get('voice_words', '') }}">
        <label for="voice_avoid">Is there any language or phrasing you want to avoid?</label>
        <textarea id="voice_avoid" name="voice_avoid" placeholder="e.g. jargon, hype, overly formal (optional)">{{ existing_intake.get('voice_avoid', '') }}</textarea>
      </div>
      <div class="form-section">
        <h2>Language</h2>
        <label for="caption_language">What language should your captions be written in?</label>
        <select id="caption_language" name="caption_language">
          <option value="English (UK)" {% if existing_intake.get('caption_language') == 'English (UK)' or not existing_intake.get('caption_language') %}selected{% endif %}>English (UK)</option>
          <option value="English (US)" {% if existing_intake.get('caption_language') == 'English (US)' %}selected{% endif %}>English (US)</option>
          <option value="Spanish" {% if existing_intake.get('caption_language') == 'Spanish' %}selected{% endif %}>Spanish</option>
          <option value="French" {% if existing_intake.get('caption_language') == 'French' %}selected{% endif %}>French</option>
          <option value="German" {% if existing_intake.get('caption_language') == 'German' %}selected{% endif %}>German</option>
          <option value="Portuguese" {% if existing_intake.get('caption_language') == 'Portuguese' %}selected{% endif %}>Portuguese</option>
        </select>
        <p class="field-helper">Spelling, idioms, and tone will match this variety (e.g. American vs British English).</p>
      </div>
      <div class="form-section">
        <h2>Platform</h2>
        {% if platforms_count > 1 %}
        <p class="field-helper" style="margin-bottom: 0.5rem;">Select up to {{ platforms_count }} platforms (included in your order). You cannot exceed the number you paid for.</p>
        <div class="intake-checkbox-group" role="group" aria-label="Platforms" id="platform-btn-group" data-max-platforms="{{ platforms_count }}">
          <button type="button" class="platform-btn" data-platform="Instagram & Facebook">Instagram &amp; Facebook</button>
          <button type="button" class="platform-btn" data-platform="LinkedIn">LinkedIn</button>
          <button type="button" class="platform-btn" data-platform="TikTok">TikTok</button>
          <button type="button" class="platform-btn" data-platform="Pinterest">Pinterest</button>
        </div>
        <input type="hidden" id="platform" name="platform" value="{{ existing_intake.get('platform', '') or prefilled_platform }}">
        {% else %}
        <label for="platform">Primary platform for these captions?</label>
        <select id="platform" name="platform">
          <option value="">— Select one —</option>
          <option value="Instagram & Facebook" {% if prefilled_platform == 'Instagram & Facebook' %}selected{% endif %}>Instagram &amp; Facebook</option>
          <option value="LinkedIn" {% if prefilled_platform == 'LinkedIn' %}selected{% endif %}>LinkedIn</option>
          <option value="TikTok" {% if prefilled_platform == 'TikTok' %}selected{% endif %}>TikTok</option>
          <option value="Pinterest" {% if prefilled_platform == 'Pinterest' %}selected{% endif %}>Pinterest</option>
        </select>
        {% endif %}
        <label for="platform_habits">Any platform-specific habits?</label>
        <input type="text" id="platform_habits" name="platform_habits" placeholder="e.g. shorter on Instagram, longer on LinkedIn (optional)" value="{{ existing_intake.get('platform_habits', '') }}">
        <div id="stories-addon-wrap" class="intake-other-wrap" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.5); border-radius: 8px; border: 1px solid #ddd;">
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.25rem;">
            <input type="checkbox" id="include_stories" name="include_stories" {% if existing_intake.get('include_stories') or stories_paid %}checked{% endif %} {% if stories_paid %}disabled{% endif %} style="width: auto;">
            <span>{% if stories_paid %}30 Stories included (already paid){% else %}Add 30 Stories prompts (+£29 one-off / +£17/mo){% endif %}</span>
          </label>
          <p class="field-helper" style="margin: 0.5rem 0 0;">One-line prompts for Instagram/Facebook Stories each day — your complete social content pack.</p>
          <label class="intake-checkbox-label" style="margin-top: 0.75rem;">
            <input type="checkbox" id="align_stories" name="align_stories" {% if existing_intake.get('align_stories_to_captions') %}checked{% endif %} style="width: auto;">
            <span>Align each Story to that day's caption (tighter pairing)</span>
          </label>
          <p class="field-helper" style="margin: 0.25rem 0 0;">If checked, Stories are generated to explicitly support each day's caption theme.</p>
        </div>
      </div>
      <div class="form-section">
        <h2 style="display: flex; align-items: center;">Hashtags<span class="help-trigger" tabindex="0" role="button" aria-label="Hashtag guidelines"><span aria-hidden="true">?</span><span class="help-tooltip"><strong>Recommended by platform:</strong><br>Instagram &amp; Facebook 2–5 (or up to 30 on Instagram)<br>LinkedIn 2–5<br>TikTok 2–5<br>Pinterest 2–5<br><br>Quality over quantity. 3–10 is a safe range for most posts.</span></span></h2>
        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.5rem;">
          <input type="checkbox" id="include_hashtags" name="include_hashtags" {% if existing_intake.get('include_hashtags', True) %}checked{% endif %} style="width: auto;">
          <span>Include suggested hashtags with each caption</span>
        </label>
        <p style="font-size: 0.9rem; color: var(--lum-text-muted); margin-bottom: 1rem;">Uncheck if you prefer no hashtags (e.g. for a clean LinkedIn look).</p>
        <div id="hashtag-range-wrap" style="margin-top: 0.5rem;">
          <label for="hashtag_min">Minimum hashtags per caption</label>
          <input type="number" id="hashtag_min" name="hashtag_min" min="1" max="30" value="{{ existing_intake.get('hashtag_min', 3) }}" placeholder="3">
          <label for="hashtag_max">Maximum hashtags per caption</label>
          <input type="number" id="hashtag_max" name="hashtag_max" min="0" max="30" value="{{ existing_intake.get('hashtag_max', 10) }}" placeholder="10">
        </div>
      </div>
      <div class="form-section">
        <h2>Goal for this month</h2>
        <label for="goal">What's the main outcome you want from this 30 days?</label>
        <select id="goal" name="goal">
          <option value="">— Select one —</option>
          <option value="More inquiries / leads" {% if existing_intake.get('goal') == 'More inquiries / leads' %}selected{% endif %}>More inquiries / leads</option>
          <option value="Build authority" {% if existing_intake.get('goal') == 'Build authority' %}selected{% endif %}>Build authority</option>
          <option value="Launch visibility" {% if existing_intake.get('goal') == 'Launch visibility' %}selected{% endif %}>Launch visibility</option>
          <option value="Grow following" {% if existing_intake.get('goal') == 'Grow following' %}selected{% endif %}>Grow following</option>
          <option value="Consistent presence" {% if existing_intake.get('goal') == 'Consistent presence' %}selected{% endif %}>Consistent presence</option>
          <option value="Other" {% if existing_intake.get('goal') and existing_intake.get('goal') not in ['More inquiries / leads', 'Build authority', 'Launch visibility', 'Grow following', 'Consistent presence'] %}selected{% endif %}>Other</option>
        </select>
        <div id="goal_other_wrap" class="intake-other-wrap" style="display: none; margin-top: 0.5rem;">
          <label for="goal_other">Describe your goal</label>
          <input type="text" id="goal_other" name="goal_other" placeholder="e.g. build my email list, promote a new offer" value="{{ existing_intake.get('goal', '') if existing_intake.get('goal') and existing_intake.get('goal') not in ['More inquiries / leads', 'Build authority', 'Launch visibility', 'Grow following', 'Consistent presence'] else '' }}">
        </div>
      </div>
      <div class="form-section">
        <h2>Key date (optional)</h2>
        <p class="field-helper" style="margin-bottom: 0.75rem;">If you have a product launch, event, sale, or similar within the next 30 days of your caption set, we'll tailor captions: before the date we build anticipation; on the day we announce; during we promote and drive action; after we shift to thank-you and feedback.</p>
        <label for="launch_event_description">What's happening? Include dates.</label>
        <input type="text" id="launch_event_description" name="launch_event_description" placeholder="e.g. Valentine's sale 10–14 Feb, product launch 20 March, Black Friday weekend 28–30 Nov" value="{{ existing_intake.get('launch_event_description', '') }}">
        <p class="field-helper">Include dates for each event (e.g. sale runs 10–14 Feb, launch on 15 March). Multiple events? List them all with their dates.</p>
      </div>
      <div class="form-section">
        <h2>Example captions (optional)</h2>
        <label for="caption_examples">Paste 1–3 example captions you like — from your own posts, competitors, or inspiration. We'll match this style, tone, and structure where relevant.</label>
        <textarea id="caption_examples" name="caption_examples" placeholder="Paste example captions here (optional)" style="min-height: 140px;">{{ existing_intake.get('caption_examples', '') }}</textarea>
      </div>
      <p id="intake-validation-hint" style="display: none; margin-bottom: 1rem; font-size: 0.9rem; color: #c00;"></p>
      <button type="button" class="btn-submit" id="btn-review">{% if existing_intake %}Review changes{% else %}Next step{% endif %}</button>
    </form>

    <div id="review-step" class="review-step">
      <h2 class="form-section" style="margin-bottom: 1rem;">Double-check your answers</h2>
      <p class="sub" style="margin-bottom: 1.5rem;">Review before sending. Click Edit to change anything.</p>
      <div id="review-content"></div>
      <div class="review-actions">
        <button type="button" class="btn-submit btn-secondary" id="btn-edit">Edit</button>
        <button type="button" class="btn-submit" id="btn-confirm">Send details</button>
      </div>
    </div>

    <p class="back" style="margin-bottom: 1rem;">
      <a href="/account/edit-form" class="intake-back-account">← Back to your account</a>
      <span style="color: #999; margin: 0 0.5rem;">|</span>
      <a href="/captions">30 Days Captions</a>
    </p>
    {% endif %}
  </main>

  {% if intake_token %}
  <script>
  (function(){
    var c = document.getElementById('audience_cb_consumers');
    var w = document.getElementById('consumer_age_wrap');
    if (c && w) {
      function ca() { w.style.display = c.checked ? 'block' : 'none'; }
      c.addEventListener('change', ca);
      c.addEventListener('click', function(){ setTimeout(ca,0); });
      ca();
    }
    var g = document.getElementById('goal');
    var gw = document.getElementById('goal_other_wrap');
    if (g && gw) {
      function go() { gw.style.display = g.value === 'Other' ? 'block' : 'none'; }
      g.addEventListener('change', go);
      go();
    }
    (function prefillCheckboxesOnLoad() {
      function gv(id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; }
      var aud = gv('audience');
      if (aud) {
        var parts = aud.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
        var otherParts = [];
        parts.forEach(function(p) {
          var cbs = document.querySelectorAll('input[name="audience_cb"]');
          var found = false;
          for (var i = 0; i < cbs.length; i++) { if (cbs[i].value === p) { cbs[i].checked = true; found = true; break; } }
          if (!found) otherParts.push(p);
        });
        var otherEl = document.getElementById('audience_other');
        if (otherEl && otherParts.length) otherEl.value = otherParts.join(', ');
      }
      var vw = gv('voice_words');
      if (vw) {
        var parts = vw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
        var otherParts = [];
        parts.forEach(function(p) {
          var cbs = document.querySelectorAll('input[name="voice_words_cb"]');
          var found = false;
          for (var i = 0; i < cbs.length; i++) { if (cbs[i].value.toLowerCase() === p.toLowerCase()) { cbs[i].checked = true; found = true; break; } }
          if (!found) otherParts.push(p);
        });
        var otherEl = document.getElementById('voice_words_other');
        if (otherEl && otherParts.length) otherEl.value = otherParts.join(', ');
      }
      var platformVal = gv('platform');
      if (platformVal) {
        var form = document.getElementById('captions-intake-form');
        var platformsCount = parseInt((form && form.getAttribute('data-platforms-count')) || '1', 10) || 1;
        var parts = platformVal.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
        var capped = parts.slice(0, platformsCount);
        var pCbs = document.querySelectorAll('input[name="platform_cb"]');
        if (pCbs.length) {
          capped.forEach(function(p) {
            pCbs.forEach(function(cb) { if (cb.value === p) cb.checked = true; });
          });
        }
      }
      var ageVal = gv('consumer_age_range');
      var consumersCb = document.getElementById('audience_cb_consumers');
      var ageWrap = document.getElementById('consumer_age_wrap');
      if (ageVal && consumersCb) { consumersCb.checked = true; if (ageWrap) ageWrap.style.display = 'block'; }
    })();

    var nextBtn = document.getElementById('btn-review');
    if (nextBtn) nextBtn.addEventListener('click', function doNextStep() {
      var form = document.getElementById('captions-intake-form');
      var reviewStep = document.getElementById('review-step');
      var reviewContent = document.getElementById('review-content');
      if (!form || !reviewStep || !reviewContent) return;
      function gv(id){ var el = document.getElementById(id); return el ? el.value.trim() : ''; }
      function gso(sid, oid){ var sel = document.getElementById(sid); if(!sel) return ''; var o = oid ? document.getElementById(oid) : null; return (sel.value === 'Other' && o) ? o.value.trim() : sel.value.trim(); }
      var audCk = document.querySelectorAll('input[name="audience_cb"]:checked');
      var aud = [].map.call(audCk, function(x){ return x.value; }).join(', ');
      if (gv('audience_other')) aud = aud ? aud + ', ' + gv('audience_other') : gv('audience_other');
      var audEl = document.getElementById('audience'); if(audEl) audEl.value = aud;
      var vwCk = document.querySelectorAll('input[name="voice_words_cb"]:checked');
      var vw = [].map.call(vwCk, function(x){ return x.value; }).join(', ');
      if (gv('voice_words_other')) vw = vw ? vw + ', ' + gv('voice_words_other') : gv('voice_words_other');
      var vwEl = document.getElementById('voice_words'); if(vwEl) vwEl.value = vw;
      var pBtns = document.querySelectorAll('.platform-btn.selected');
      if (pBtns.length) { var pv = [].map.call(pBtns, function(b){ return b.getAttribute('data-platform'); }).filter(Boolean); var pEl = document.getElementById('platform'); if(pEl) pEl.value = pv.join(', '); }
      else { var pCbs = document.querySelectorAll('input[name="platform_cb"]'); if (pCbs.length) { var pv = [].filter.call(pCbs, function(x){ return x.checked; }).map(function(x){ return x.value; }); var pEl = document.getElementById('platform'); if(pEl) pEl.value = pv.join(', '); } }
      var hint = document.getElementById('intake-validation-hint');
      if (hint) { hint.style.display = 'none'; hint.textContent = ''; }
      if (!form.checkValidity()) {
        form.reportValidity();
        var inv = form.querySelector(':invalid'); if (inv && inv.scrollIntoView) inv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        if (hint) { hint.textContent = 'Please complete the required fields above (e.g. business name).'; hint.style.display = 'block'; }
        return;
      }
      function sect(t,v){ var p = document.createElement('p'); p.textContent = v || '(not provided)'; if(!v) p.className = 'empty'; var h = document.createElement('h3'); h.textContent = t; var d = document.createElement('div'); d.className = 'review-section'; d.appendChild(h); d.appendChild(p); return d; }
      reviewContent.innerHTML = '';
      reviewContent.appendChild(sect('Business name', gv('business_name')));
      reviewContent.appendChild(sect('Business type', gso('business_type', 'business_type_other') || '(not provided)'));
      reviewContent.appendChild(sect('What you offer', gv('offer_one_line')));
      reviewContent.appendChild(sect('Primary audience', gv('audience') || '(not provided)'));
      if (gv('consumer_age_range')) reviewContent.appendChild(sect('Consumer age range', gv('consumer_age_range')));
      reviewContent.appendChild(sect('What they care about', gv('audience_cares')));
      reviewContent.appendChild(sect('Voice (3–5 words)', gv('voice_words') || '(not provided)'));
      reviewContent.appendChild(sect('Language to avoid', gv('voice_avoid')));
      reviewContent.appendChild(sect('Caption language', gv('caption_language') || 'English (UK)'));
      reviewContent.appendChild(sect('Primary platform', gv('platform') || '(not provided)'));
      reviewContent.appendChild(sect('Platform habits', gv('platform_habits')));
      var inc = document.getElementById('include_hashtags');
      var storiesCb = document.getElementById('include_stories');
      if (storiesCb && storiesCb.offsetParent) {
        var alignCb = document.getElementById('align_stories');
        var label = storiesCb.checked ? 'Yes — 30 story prompts' : 'No';
        if (storiesCb.checked && alignCb && alignCb.checked) {
          label += ' (aligned to each caption)';
        }
        reviewContent.appendChild(sect('Stories add-on', label));
      }
      reviewContent.appendChild(sect('Hashtags', inc && inc.checked ? 'Yes, ' + (gv('hashtag_min')||'3') + '–' + (gv('hashtag_max')||'10') + ' per caption' : 'No'));
      reviewContent.appendChild(sect('Goal for this month', gso('goal', 'goal_other') || '(not provided)'));
      var launchDesc = gv('launch_event_description');
      if (launchDesc) reviewContent.appendChild(sect('Key date', launchDesc));
      reviewContent.appendChild(sect('Example captions', gv('caption_examples')));
      form.style.display = 'none';
      reviewStep.classList.add('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    var btnEdit = document.getElementById('btn-edit');
    if (btnEdit) btnEdit.addEventListener('click', function() {
      var rs = document.getElementById('review-step');
      var f = document.getElementById('captions-intake-form');
      if (rs) rs.classList.remove('show');
      if (f) f.style.display = 'block';
    });
    var btnConfirm = document.getElementById('btn-confirm');
    if (btnConfirm) btnConfirm.addEventListener('click', function sendDetails() {
      function gv(id){ var el = document.getElementById(id); return el ? el.value.trim() : ''; }
      function gso(sid, oid){ var sel = document.getElementById(sid); if(!sel) return ''; var o = oid ? document.getElementById(oid) : null; return (sel.value === 'Other' && o) ? o.value.trim() : sel.value.trim(); }
      var audCk = document.querySelectorAll('input[name="audience_cb"]:checked');
      var aud = [].map.call(audCk, function(x){ return x.value; }).join(', ');
      if (gv('audience_other')) aud = aud ? aud + ', ' + gv('audience_other') : gv('audience_other');
      var audEl = document.getElementById('audience'); if(audEl) audEl.value = aud;
      var vwCk = document.querySelectorAll('input[name="voice_words_cb"]:checked');
      var vw = [].map.call(vwCk, function(x){ return x.value; }).join(', ');
      if (gv('voice_words_other')) vw = vw ? vw + ', ' + gv('voice_words_other') : gv('voice_words_other');
      var vwEl = document.getElementById('voice_words'); if(vwEl) vwEl.value = vw;
      var pBtns = document.querySelectorAll('.platform-btn.selected');
      if (pBtns.length) { var pv = [].map.call(pBtns, function(b){ return b.getAttribute('data-platform'); }).filter(Boolean); var pEl = document.getElementById('platform'); if(pEl) pEl.value = pv.join(', '); }
      else { var pCbs = document.querySelectorAll('input[name="platform_cb"]'); if (pCbs.length) { var pv = [].filter.call(pCbs, function(x){ return x.checked; }).map(function(x){ return x.value; }); var pEl = document.getElementById('platform'); if(pEl) pEl.value = pv.join(', '); } }
      var inc = document.getElementById('include_hashtags');
      var minH = parseInt(document.getElementById('hashtag_min') ? document.getElementById('hashtag_min').value : 3, 10) || 3;
      var maxH = parseInt(document.getElementById('hashtag_max') ? document.getElementById('hashtag_max').value : 10, 10) || 10;
      if (minH > maxH) maxH = minH;
      var payload = {
        token: gv('intake_token'),
        business_name: gv('business_name'),
        business_type: gso('business_type', 'business_type_other'),
        offer_one_line: gv('offer_one_line'),
        audience: gv('audience'),
        consumer_age_range: gv('consumer_age_range'),
        audience_cares: gv('audience_cares'),
        voice_words: gv('voice_words'),
        voice_avoid: gv('voice_avoid'),
        platform: gv('platform'),
        platform_habits: gv('platform_habits'),
        include_hashtags: inc ? inc.checked : true,
        hashtag_min: minH,
        hashtag_max: maxH,
        goal: gso('goal', 'goal_other'),
        launch_event_description: gv('launch_event_description'),
        caption_examples: gv('caption_examples'),
        caption_language: gv('caption_language') || 'English (UK)',
        include_stories: !!(document.getElementById('include_stories') && document.getElementById('include_stories').checked),
        align_stories_to_captions: !!(document.getElementById('align_stories') && document.getElementById('align_stories').checked)
      };
      var btn = document.getElementById('btn-confirm');
      if (btn) { btn.disabled = true; btn.textContent = 'Sending…'; }
      fetch('/api/captions-intake', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(function(r){ return r.json().then(function(j){ return { status: r.status, json: j }; }); })
        .then(function(result) {
          if (result.status === 200 && result.json.success) {
            var rs = document.getElementById('review-step');
            if (rs) rs.classList.remove('show');
            var successEl = document.getElementById('intake-success');
            if (successEl) successEl.style.display = 'block';
            var msgEl = document.getElementById('intake-success-msg');
            if (msgEl) {
              if (result.json.is_subscription) {
                msgEl.textContent = "Your captions are on the way. Create an account to manage your subscription, re-download captions, and cancel anytime.";
              } else if (result.json.message) {
                msgEl.textContent = result.json.message;
              }
            }
            var createAccountBox = document.getElementById('create-account-box');
            var caRequiredNote = document.getElementById('ca-required-note');
            var caCreateState = document.getElementById('ca-create-state');
            var caDone = document.getElementById('ca-done');
            var caAlreadyLoggedIn = document.getElementById('ca-already-logged-in');
            var caAlreadyHasAccount = document.getElementById('ca-already-has-account');
            if (result.json.is_subscription) {
              if (createAccountBox) createAccountBox.setAttribute('data-required', 'true');
              if (caRequiredNote) caRequiredNote.style.display = 'block';
            } else {
              if (createAccountBox) createAccountBox.removeAttribute('data-required');
              if (caRequiredNote) caRequiredNote.style.display = 'none';
            }
            var caEmail = document.getElementById('ca-email');
            var custEmail = (result.json.customer_email || '').trim().toLowerCase();
            if (caEmail && custEmail) { caEmail.value = custEmail; }
            var caEmailText = document.getElementById('ca-email-text');
            var caEmailDisplay = document.getElementById('ca-email-display');
            if (caEmailText && caEmailDisplay && custEmail) { caEmailText.textContent = result.json.customer_email || custEmail; caEmailDisplay.style.display = 'block'; }
            var currentEmail = (document.body.getAttribute('data-current-customer-email') || '').trim().toLowerCase();
            var isLoggedInAndMatches = currentEmail && custEmail && currentEmail === custEmail;
            var hasAccount = !!result.json.customer_has_account;
            if (caCreateState) caCreateState.style.display = 'none';
            if (caDone) caDone.style.display = 'none';
            if (caAlreadyLoggedIn) caAlreadyLoggedIn.style.display = 'none';
            if (caAlreadyHasAccount) caAlreadyHasAccount.style.display = 'none';
            if (isLoggedInAndMatches) {
              if (caAlreadyLoggedIn) caAlreadyLoggedIn.style.display = 'block';
            } else if (hasAccount) {
              if (caAlreadyHasAccount) caAlreadyHasAccount.style.display = 'block';
            } else {
              if (caCreateState) caCreateState.style.display = 'block';
            }
          } else {
            var errEl = document.getElementById('intake-error');
            if (errEl) { errEl.textContent = result.json.error || 'Something didn\'t send — try again or email us at hello@lumo22.com.'; errEl.style.display = 'block'; }
            if (btn) { btn.disabled = false; btn.textContent = 'Send details'; }
          }
        })
        .catch(function() {
          var errEl = document.getElementById('intake-error');
          if (errEl) { errEl.textContent = 'Something didn\'t send — try again or email hello@lumo22.com.'; errEl.style.display = 'block'; }
          if (btn) { btn.disabled = false; btn.textContent = 'Send details'; }
        });
    });
    (function setupPlatformButtons() {
      var group = document.getElementById('platform-btn-group');
      if (!group) return;
      var btns = group.querySelectorAll('.platform-btn');
      if (!btns.length) return;
      var platformEl = document.getElementById('platform');
      var maxPlatforms = parseInt(group.getAttribute('data-max-platforms') || '1', 10) || 1;
      maxPlatforms = Math.max(1, Math.min(4, maxPlatforms));
      var selected = [];
      function norm(p) {
        if (p === 'Instagram' || p === 'Facebook') return 'Instagram & Facebook';
        return p;
      }
      function render() {
        btns.forEach(function(btn) {
          var val = btn.getAttribute('data-platform');
          var isSel = selected.indexOf(val) !== -1;
          btn.classList.toggle('selected', isSel);
          btn.disabled = !isSel && selected.length >= maxPlatforms;
        });
        if (platformEl) platformEl.value = selected.join(', ');
      }
      btns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var val = btn.getAttribute('data-platform');
          var idx = selected.indexOf(val);
          if (idx !== -1) {
            selected.splice(idx, 1);
          } else if (selected.length < maxPlatforms) {
            selected.push(val);
          }
          render();
        });
      });
      var initialVal = (platformEl && platformEl.value || '').trim();
      if (initialVal) {
        var parts = initialVal.split(',').map(function(s) { return norm(s.trim()); }).filter(Boolean);
        var seen = {};
        selected = [];
        for (var i = 0; i < parts.length && selected.length < maxPlatforms; i++) {
          var p = parts[i];
          if (!seen[p]) { seen[p] = true; selected.push(p); }
        }
      }
      render();
      function toggleStories() {
        var wrap = document.getElementById('stories-addon-wrap');
        if (!wrap) return;
        var platformVal = (platformEl && platformEl.value || '').trim();
        var hasIGFB = platformVal.toLowerCase().indexOf('instagram') !== -1 || platformVal.toLowerCase().indexOf('facebook') !== -1;
        wrap.style.display = hasIGFB ? 'block' : 'none';
        if (!hasIGFB) {
          var cb = document.getElementById('include_stories');
          if (cb) cb.checked = false;
        }
      }
      toggleStories();
      btns.forEach(function(btn) { btn.addEventListener('click', toggleStories); });
      var platformSelect = document.getElementById('platform');
      if (platformSelect && platformSelect.tagName === 'SELECT') {
        platformSelect.addEventListener('change', toggleStories);
      }
    })();
    (function setupStoriesForSinglePlatform() {
      var wrap = document.getElementById('stories-addon-wrap');
      var platformSelect = document.getElementById('platform');
      if (!wrap || !platformSelect || platformSelect.tagName !== 'SELECT') return;
      function hasInstagramFacebook(val) {
        var s = (val || '').toLowerCase();
        return s.indexOf('instagram') !== -1 || s.indexOf('facebook') !== -1;
      }
      function toggleStories() {
        var hasIGFB = hasInstagramFacebook(platformSelect.value);
        wrap.style.display = hasIGFB ? 'block' : 'none';
        if (!hasIGFB) {
          var cb = document.getElementById('include_stories');
          if (cb) cb.checked = false;
        }
      }
      platformSelect.addEventListener('change', toggleStories);
      toggleStories();
    })();
    var caForm = document.getElementById('create-account-form');
    if (caForm) {
      caForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var emailEl = document.getElementById('ca-email');
        var email = (emailEl ? emailEl.value : '').trim();
        var pwEl = document.getElementById('ca-password');
        var pw = pwEl ? pwEl.value : '';
        if (!email) { alert('Just need your email to continue.'); return; }
        if (pw.length < 6) { alert('Password must be at least 6 characters.'); return; }
        var caBtn = document.getElementById('ca-btn');
        if (caBtn) { caBtn.disabled = true; caBtn.textContent = 'Creating…'; }
        fetch('/api/auth/create-account', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email.toLowerCase(), password: pw }) })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.ok) {
              var formEl = document.getElementById('create-account-form');
              if (formEl) formEl.style.display = 'none';
              var doneEl = document.getElementById('ca-done');
              if (doneEl) doneEl.style.display = 'block';
            } else {
              alert(data.error || 'Something didn\'t go through — try again.');
              if (caBtn) { caBtn.disabled = false; caBtn.textContent = 'Create account'; }
            }
          })
          .catch(function() {
            alert('Something didn\'t send — try again.');
            if (caBtn) { caBtn.disabled = false; caBtn.textContent = 'Create account'; }
          });
      });
    }
  })();
  </script>
  <script>
    (function() {
      function runWhenReady(fn) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fn);
        } else {
          fn();
        }
      }
      runWhenReady(function() {
      var form = document.getElementById('captions-intake-form');
      var reviewStep = document.getElementById('review-step');
      var reviewContent = document.getElementById('review-content');
      var btnReview = document.getElementById('btn-review');
      var btnEdit = document.getElementById('btn-edit');
      var btnConfirm = document.getElementById('btn-confirm');

      var platformsCount = parseInt((form && form.getAttribute('data-platforms-count')) || '1', 10) || 1;
      function getVal(id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; }
      function getSelectOrOther(selectId, otherId) {
        var sel = document.getElementById(selectId);
        if (!sel) return '';
        var other = otherId ? document.getElementById(otherId) : null;
        if (sel.value === 'Other' && other) return other.value.trim();
        return sel.value.trim();
      }
      function syncAudience() {
        var checked = Array.prototype.slice.call(document.querySelectorAll('input[name="audience_cb"]:checked')).map(function(c) { return c.value; });
        var other = getVal('audience_other');
        var combined = checked.length ? checked.join(', ') : '';
        if (other) combined = combined ? combined + ', ' + other : other;
        var el = document.getElementById('audience');
        if (el) el.value = combined;
      }
      function syncVoiceWords() {
        var checked = Array.prototype.slice.call(document.querySelectorAll('input[name="voice_words_cb"]:checked')).map(function(c) { return c.value; });
        var other = getVal('voice_words_other');
        var combined = checked.length ? checked.join(', ') : '';
        if (other) combined = combined ? combined + ', ' + other : other;
        var el = document.getElementById('voice_words');
        if (el) el.value = combined;
      }
      function syncPlatforms() {
        var btns = document.querySelectorAll('.platform-btn.selected');
        if (btns.length) {
          var parts = [].map.call(btns, function(b) { return b.getAttribute('data-platform'); }).filter(Boolean);
          var el = document.getElementById('platform');
          if (el) el.value = parts.join(', ');
          return;
        }
        var cbs = document.querySelectorAll('input[name="platform_cb"]');
        if (!cbs.length) return;
        var checked = [].slice.call(cbs).filter(function(c) { return c.checked; });
        var parts = checked.map(function(c) { return c.value; }).filter(Boolean);
        var el = document.getElementById('platform');
        if (el) el.value = parts.join(', ');
      }
      function sect(t, v) {
        var p = document.createElement('p');
        p.textContent = v || '(not provided)';
        if (!v) p.className = 'empty';
        var h = document.createElement('h3');
        h.textContent = t;
        var div = document.createElement('div');
        div.className = 'review-section';
        div.appendChild(h);
        div.appendChild(p);
        return div;
      }
      function showReview() {
        var form = document.getElementById('captions-intake-form');
        var reviewStep = document.getElementById('review-step');
        var reviewContent = document.getElementById('review-content');
        if (!form || !reviewStep || !reviewContent) return;
        var hintEl = document.getElementById('intake-validation-hint');
        if (hintEl) { hintEl.style.display = 'none'; hintEl.textContent = ''; }
        syncAudience();
        syncVoiceWords();
        if (document.querySelectorAll('.platform-btn, input[name="platform_cb"]').length) syncPlatforms();
        if (!form.checkValidity()) {
          form.reportValidity();
          var firstInvalid = form.querySelector(':invalid');
          if (firstInvalid && firstInvalid.scrollIntoView) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          if (hintEl) { hintEl.textContent = 'Please complete the required fields above (e.g. business name).'; hintEl.style.display = 'block'; }
          return;
        }
        reviewContent.innerHTML = '';
        reviewContent.appendChild(sect('Business name', getVal('business_name')));
        reviewContent.appendChild(sect('Business type', getSelectOrOther('business_type', 'business_type_other') || '(not provided)'));
        reviewContent.appendChild(sect('What you offer', getVal('offer_one_line')));
        reviewContent.appendChild(sect('Primary audience', getVal('audience') || '(not provided)'));
        var ageRange = getVal('consumer_age_range');
        if (ageRange) reviewContent.appendChild(sect('Consumer age range', ageRange));
        reviewContent.appendChild(sect('What they care about', getVal('audience_cares')));
        reviewContent.appendChild(sect('Voice (3–5 words)', getVal('voice_words') || '(not provided)'));
        reviewContent.appendChild(sect('Language to avoid', getVal('voice_avoid')));
        reviewContent.appendChild(sect('Caption language', getVal('caption_language') || 'English (UK)'));
        reviewContent.appendChild(sect('Primary platform', getVal('platform') || '(not provided)'));
        reviewContent.appendChild(sect('Platform habits', getVal('platform_habits')));
        var storiesCb = document.getElementById('include_stories');
        if (storiesCb && storiesCb.offsetParent) reviewContent.appendChild(sect('Stories add-on', storiesCb.checked ? 'Yes — 30 story prompts' : 'No'));
        var incCb = document.getElementById('include_hashtags');
        var hashtags = incCb && incCb.checked ? 'Yes, ' + (getVal('hashtag_min') || '3') + '–' + (getVal('hashtag_max') || '10') + ' per caption' : 'No';
        reviewContent.appendChild(sect('Hashtags', hashtags));
        reviewContent.appendChild(sect('Goal for this month', getSelectOrOther('goal', 'goal_other') || '(not provided)'));
        var launchDesc = getVal('launch_event_description');
        if (launchDesc) reviewContent.appendChild(sect('Key date', launchDesc));
        reviewContent.appendChild(sect('Example captions', getVal('caption_examples')));
        form.style.display = 'none';
        reviewStep.classList.add('show');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      window.doShowReview = showReview;
      if (!form || !reviewStep || !reviewContent || !btnReview) return;

      function showForm() {
        var reviewStep = document.getElementById('review-step');
        var form = document.getElementById('captions-intake-form');
        if (reviewStep) reviewStep.classList.remove('show');
        if (form) form.style.display = 'block';
      }
      function submitForm() {
        syncAudience();
        syncVoiceWords();
        if (document.querySelectorAll('.platform-btn, input[name="platform_cb"]').length) syncPlatforms();
        var incHashtags = document.getElementById('include_hashtags').checked;
        var minH = parseInt(document.getElementById('hashtag_min').value, 10) || 3;
        var maxH = parseInt(document.getElementById('hashtag_max').value, 10) || 10;
        if (minH > maxH) maxH = minH;
        var payload = {
          token: getVal('intake_token'),
          business_name: getVal('business_name'),
          business_type: getSelectOrOther('business_type', 'business_type_other'),
          offer_one_line: getVal('offer_one_line'),
          audience: getVal('audience'),
          consumer_age_range: getVal('consumer_age_range'),
          audience_cares: getVal('audience_cares'),
          voice_words: getVal('voice_words'),
          voice_avoid: getVal('voice_avoid'),
          platform: getVal('platform'),
          platform_habits: getVal('platform_habits'),
          include_hashtags: incHashtags,
          hashtag_min: minH,
          hashtag_max: maxH,
          goal: getSelectOrOther('goal', 'goal_other'),
          launch_event_description: getVal('launch_event_description'),
          caption_examples: getVal('caption_examples'),
          include_stories: !!(document.getElementById('include_stories') && document.getElementById('include_stories').checked),
          align_stories_to_captions: !!(document.getElementById('align_stories') && document.getElementById('align_stories').checked)
        };
        btnConfirm.disabled = true;
        btnConfirm.textContent = 'Sending…';
        fetch('/api/captions-intake', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json().then(function(j) { return { status: r.status, json: j }; }); })
        .then(function(result) {
          if (result.status === 200 && result.json.success) {
            reviewStep.classList.remove('show');
            var successEl = document.getElementById('intake-success');
            successEl.style.display = 'block';
            var msgEl = document.getElementById('intake-success-msg');
            if (msgEl && result.json.message) msgEl.textContent = result.json.message;
            var custEmail = (result.json.customer_email || '').trim();
            document.getElementById('ca-email').value = custEmail;
          } else {
            document.getElementById('intake-error').textContent = result.json.error || 'Something didn't send — try again or email us at hello@lumo22.com.';
            document.getElementById('intake-error').style.display = 'block';
            btnConfirm.disabled = false;
            btnConfirm.textContent = 'Send details';
          }
        })
        .catch(function() {
          document.getElementById('intake-error').textContent = 'Something didn't send — try again or email hello@lumo22.com.';
          document.getElementById('intake-error').style.display = 'block';
          btnConfirm.disabled = false;
          btnConfirm.textContent = 'Send details';
        });
      }

      if (btnEdit) btnEdit.addEventListener('click', showForm);

      (function goalOtherToggle() {
        var goalSelect = document.getElementById('goal');
        var goalWrap = document.getElementById('goal_other_wrap');
        if (!goalSelect || !goalWrap) return;
        function showHide() {
          goalWrap.style.display = goalSelect.value === 'Other' ? 'block' : 'none';
        }
        goalSelect.addEventListener('change', showHide);
        showHide();
      })();

      (function consumerAgeToggle() {
        var consumersCb = document.getElementById('audience_cb_consumers');
        var wrap = document.getElementById('consumer_age_wrap');
        if (!consumersCb || !wrap) return;
        function showHide() {
          var show = consumersCb.checked;
          wrap.style.display = show ? 'block' : 'none';
          wrap.setAttribute('aria-hidden', show ? 'false' : 'true');
        }
        consumersCb.addEventListener('change', showHide);
        consumersCb.addEventListener('click', function() { setTimeout(showHide, 0); });
        var ageInput = document.getElementById('consumer_age_range');
        if (ageInput && ageInput.value.trim()) {
          consumersCb.checked = true;
          showHide();
        } else {
          showHide();
        }
      })();

      try {

      function toggleHashtagRange() {
        var wrap = document.getElementById('hashtag-range-wrap');
        var cb = document.getElementById('include_hashtags');
        if (wrap && cb) wrap.style.display = cb.checked ? '' : 'none';
      }
      var includeHashtags = document.getElementById('include_hashtags');
      if (includeHashtags) { includeHashtags.addEventListener('change', toggleHashtagRange); toggleHashtagRange(); }

      function toggleOtherFields() {
        var bt = document.getElementById('business_type');
        var bto = document.getElementById('business_type_other');
        if (bt && bto) bto.style.display = bt.value === 'Other' ? 'block' : 'none';
        var goalSelect = document.getElementById('goal');
        var goalOtherWrap = document.getElementById('goal_other_wrap');
        if (goalSelect && goalOtherWrap) {
          goalOtherWrap.style.display = goalSelect.value === 'Other' ? 'block' : 'none';
          goalOtherWrap.setAttribute('aria-hidden', goalSelect.value === 'Other' ? 'false' : 'true');
        }
      }
      ['business_type', 'goal'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', toggleOtherFields);
      });
      toggleOtherFields();
      function toggleConsumerAge() {
        var consumersCb = document.getElementById('audience_cb_consumers');
        var wrap = document.getElementById('consumer_age_wrap');
        if (wrap && consumersCb) {
          wrap.style.display = consumersCb.checked ? 'block' : 'none';
          wrap.setAttribute('aria-hidden', consumersCb.checked ? 'false' : 'true');
        }
      }
      var consumersCb = document.getElementById('audience_cb_consumers');
      if (consumersCb) {
        consumersCb.addEventListener('change', toggleConsumerAge);
        consumersCb.addEventListener('click', function() { setTimeout(toggleConsumerAge, 0); });
      }
      if (getVal('consumer_age_range') && consumersCb) {
        consumersCb.checked = true;
        toggleConsumerAge();
      } else {
        toggleConsumerAge();
      }
      document.querySelectorAll('input[name="audience_cb"], #audience_other').forEach(function(el) { el.addEventListener('change', syncAudience); el.addEventListener('input', syncAudience); });
      document.querySelectorAll('input[name="voice_words_cb"], #voice_words_other').forEach(function(el) { el.addEventListener('change', syncVoiceWords); el.addEventListener('input', syncVoiceWords); });
      (function prefillCheckboxes() {
        var aud = getVal('audience');
        if (aud) {
          var parts = aud.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
          var otherParts = [];
          parts.forEach(function(p) {
            var cbs = document.querySelectorAll('input[name="audience_cb"]');
            var found = false;
            for (var i = 0; i < cbs.length; i++) { if (cbs[i].value === p) { cbs[i].checked = true; found = true; break; } }
            if (!found) otherParts.push(p);
          });
          var otherEl = document.getElementById('audience_other');
          if (otherEl && otherParts.length) otherEl.value = otherParts.join(', ');
        }
        var vw = getVal('voice_words');
        if (vw) {
          var parts = vw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
          var otherParts = [];
          parts.forEach(function(p) {
            var cbs = document.querySelectorAll('input[name="voice_words_cb"]');
            var found = false;
            for (var i = 0; i < cbs.length; i++) { if (cbs[i].value.toLowerCase() === p.toLowerCase()) { cbs[i].checked = true; found = true; break; } }
            if (!found) otherParts.push(p);
          });
          var otherEl = document.getElementById('voice_words_other');
          if (otherEl && otherParts.length) otherEl.value = otherParts.join(', ');
        }
        syncAudience();
        syncVoiceWords();
        toggleConsumerAge();
      })();

      } catch (e) { if (typeof console !== 'undefined' && console.error) console.error('Intake setup:', e); }

      }); // end runWhenReady
    })();
  </script>
  {% endif %}
  {% include '_footer.html' %}
</body>
</html>
