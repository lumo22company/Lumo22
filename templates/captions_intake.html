<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>30 Days Captions — Your details | Lumo 22</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <meta name="description" content="Complete the form so we can tailor your 30 days of social media captions.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans+Condensed:wght@400;500;600;700&family=Inter+Tight:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}?v={{ asset_version }}">
  <style>
    .intake-page {
      padding: 2rem 1.5rem 4rem;
      max-width: 560px;
      margin: 6rem auto 4rem;
      background: var(--bg-light);
      color: #1a1a1a;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    }
    .intake-page h1 { font-family: var(--font-display); font-size: 1.75rem; margin-bottom: 0.5rem; color: #000; }
    .intake-page .sub { color: #555; margin-bottom: 2.5rem; }
    .intake-page label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; color: #1a1a1a; }
    .intake-page input, .intake-page textarea {
      width: 100%; padding: 0.75rem 1rem;
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      color: #111; font-family: var(--font-body); font-size: 1rem; margin-bottom: 1.25rem;
    }
    .intake-page input:focus, .intake-page textarea:focus { outline: none; border-color: #666; }
    .intake-page textarea { min-height: 100px; resize: vertical; }
    .intake-page input::placeholder, .intake-page textarea::placeholder { color: #666; }
    .intake-page .form-section { margin-bottom: 2rem; }
    .intake-page .form-section h2 { font-family: 'Encode Sans Condensed', sans-serif; font-size: 1.1rem; color: #555; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .intake-page .btn-submit {
      display: inline-block; padding: 1rem 2rem;
      background: var(--lum-gold); color: #000;
      text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; border: none; cursor: pointer; font-family: var(--font-display);
    }
    .intake-page .btn-submit:hover { opacity: 0.95; }
    .intake-page .back { margin-top: 2rem; }
    .intake-page .back a { color: #555; text-decoration: none; font-size: 0.95rem; }
    .intake-page .back a:hover { color: #000; }
    .intake-page a[href] { color: #1a1a1a; }
    .intake-page a[href]:hover { color: #000; text-decoration: underline; }
    .intake-page .review-step { display: none; margin-bottom: 2rem; }
    .intake-page .review-step.show { display: block; }
    .intake-page .review-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #ddd; }
    .intake-page .review-section:last-of-type { border-bottom: none; }
    .intake-page .review-section h3 { font-size: 0.85rem; color: #555; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .intake-page .review-section p { margin: 0; font-size: 0.95rem; line-height: 1.5; color: #1a1a1a; white-space: pre-wrap; }
    .intake-page .review-section .empty { color: #666; font-style: italic; }
    .intake-page .review-actions { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; }
    .intake-page .btn-secondary { background: transparent; color: #333; border: 1px solid #999; }
    .intake-page .btn-secondary:hover { border-color: #666; color: #000; }
    .intake-page .help-trigger { display: inline-flex; align-items: center; justify-content: center; width: 1.1rem; height: 1.1rem; border-radius: 50%; background: #999; color: #fff; font-size: 0.7rem; font-weight: 600; cursor: help; margin-left: 0.4rem; vertical-align: middle; position: relative; }
    .intake-page .help-trigger:hover, .intake-page .help-trigger:focus { background: var(--lum-gold); color: #000; outline: none; }
    .intake-page .help-tooltip { position: absolute; left: 50%; transform: translateX(-50%); bottom: calc(100% + 0.5rem); width: min(280px, 90vw); padding: 1rem; background: #1a1a1a; color: #f5f5f2; font-size: 0.8rem; line-height: 1.5; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 1px solid #333; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 100; pointer-events: none; text-align: left; font-weight: 400; }
    .intake-page .help-trigger:hover .help-tooltip, .intake-page .help-trigger:focus .help-tooltip { opacity: 1; visibility: visible; }
    .intake-page .help-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border: 6px solid transparent; border-top-color: #1a1a1a; }
    .intake-page .field-helper { font-size: 0.85rem; color: #555; margin: -0.75rem 0 1rem; line-height: 1.4; }
    .intake-page #intake-success .btn-submit { background: var(--lum-gold); color: #000; }
    .intake-page #intake-success div[style*="background"] { background: #f0f0ee !important; border: 1px solid #ddd; }
    .intake-page #intake-error { background: rgba(200,80,80,0.12); color: #1a1a1a; border: 1px solid rgba(200,80,80,0.3); }
    .intake-page select { width: 100%; padding: 0.75rem 1rem; background: #fff; border: 1px solid #ccc; border-radius: 8px; color: #111; font-family: var(--font-body); font-size: 1rem; margin-bottom: 1.25rem; }
    .intake-page select:focus { outline: none; border-color: #666; }
    .intake-checkbox-group { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; margin-bottom: 0.25rem; }
    .intake-checkbox-label { display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 400; font-size: 0.95rem; }
    .intake-checkbox-label input { width: auto; margin: 0; }
  </style>
</head>
<body class="lumo-landing">
  <nav class="lumo-nav lumo-nav-scrolled">
    <a href="/" class="lumo-nav-logo">Lumo 22</a>
    <div class="lumo-nav-links">
      <a href="/captions">Captions</a>
      <a href="/digital-front-desk">Front Desk</a>
      <a href="/digital-front-desk#pricing">Pricing</a>
    </div>
    <a href="/captions" class="lumo-nav-cta">Get my 30 days</a>
  </nav>

  <main class="intake-page">
    <h1>30 Days Captions — Your details</h1>
    <p class="sub">Complete this form so we can tailor your caption set. Your answers shape your voice and structure for the month.</p>

    {% if not intake_token %}
    <p class="sub" style="margin-top: 1rem;">Use the link from your order email to complete the form. If you just purchased, check your inbox for a message from us with a personalised link.</p>
    <p class="sub" style="margin-top: 0.5rem;">Haven't bought yet? <a href="/captions" style="color: var(--lum-gold);">Get 30 Days Captions</a></p>
    <p class="back"><a href="/captions">← Back to 30 Days Captions</a></p>
    {% else %}
    <div id="intake-success" style="display: none; margin: 2rem 0;">
      <div style="padding: 1.5rem; background: var(--lum-surface-elevated); border-radius: 8px; margin-bottom: 1rem;">
        <p id="intake-success-msg" style="margin: 0;">Request received. We'll take it from here — your captions will arrive by email within a few minutes.</p>
      </div>
      <div id="create-account-box" style="padding: 1.25rem; background: var(--lum-surface-elevated); border-radius: 8px; border: 1px solid var(--lum-border);">
        <p style="margin: 0 0 1rem; font-weight: 500;">Create an account to access your captions and more in one place.</p>
        <form id="create-account-form" style="max-width: 320px;">
          <input type="hidden" id="ca-email" value="">
          <label for="ca-password" style="display:block; font-size:0.9rem; margin-bottom:0.25rem;">Password (min 6 characters)</label>
          <input type="password" id="ca-password" required minlength="6" style="width:100%; padding:0.5rem 0.75rem; margin-bottom:0.75rem; border-radius:6px; border:1px solid var(--lum-border);">
          <button type="submit" class="btn-submit" id="ca-btn">Create account</button>
        </form>
        <p id="ca-done" style="display:none; margin:0; color: var(--lum-gold);">Account created! <a href="/account" style="color:inherit;">Go to your account</a></p>
      </div>
    </div>
    <div id="intake-error" style="display: none; margin: 2rem 0; padding: 1.5rem; background: rgba(200,80,80,0.15); border-radius: 8px; color: var(--lum-text);"></div>

    <form id="captions-intake-form" action="#" method="post" data-platforms-count="{{ platforms_count }}">
      <input type="hidden" name="token" id="intake_token" value="{{ intake_token }}">
      <div class="form-section">
        <h2>Business</h2>
        <label for="business_name">What is your business name?</label>
        <input type="text" id="business_name" name="business_name" required placeholder="e.g. Lumo 22, Acme Coaching" value="{{ existing_intake.get('business_name', '') }}">
        <label for="business_type">What type of business do you run?</label>
        <select id="business_type" name="business_type">
          <option value="">— Select one —</option>
          <option value="Consultancy" {% if existing_intake.get('business_type') == 'Consultancy' %}selected{% endif %}>Consultancy</option>
          <option value="Agency" {% if existing_intake.get('business_type') == 'Agency' %}selected{% endif %}>Agency</option>
          <option value="Coach / Mentor" {% if existing_intake.get('business_type') == 'Coach / Mentor' %}selected{% endif %}>Coach / Mentor</option>
          <option value="Product brand" {% if existing_intake.get('business_type') == 'Product brand' %}selected{% endif %}>Product brand</option>
          <option value="Creative / Freelancer" {% if existing_intake.get('business_type') == 'Creative / Freelancer' %}selected{% endif %}>Creative / Freelancer</option>
          <option value="E-commerce" {% if existing_intake.get('business_type') == 'E-commerce' %}selected{% endif %}>E-commerce</option>
          <option value="Other" {% if existing_intake.get('business_type') and existing_intake.get('business_type') not in ['Consultancy', 'Agency', 'Coach / Mentor', 'Product brand', 'Creative / Freelancer', 'E-commerce'] %}selected{% endif %}>Other</option>
        </select>
        <input type="text" id="business_type_other" name="business_type_other" placeholder="Specify your business type" class="intake-other-field" style="display: none; margin-top: 0.5rem;" value="{{ existing_intake.get('business_type', '') if existing_intake.get('business_type') and existing_intake.get('business_type') not in ['Consultancy', 'Agency', 'Coach / Mentor', 'Product brand', 'Creative / Freelancer', 'E-commerce'] else '' }}">
        <label for="offer_one_line">In one sentence, what do you offer and to whom?</label>
        <textarea id="offer_one_line" name="offer_one_line" placeholder="e.g. We help busy founders build a content habit without the daily grind">{{ existing_intake.get('offer_one_line', '') }}</textarea>
        <p class="field-helper">A couple of sentences is enough.</p>
      </div>
      <div class="form-section">
        <h2>Audience</h2>
        <p class="field-helper" style="margin-bottom: 0.5rem;">Who is your primary audience? (pick any that apply)</p>
        <div class="intake-checkbox-group" role="group" aria-label="Primary audience">
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Founders"> Founders</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Small business owners"> Small business owners</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Marketing leads"> Marketing leads</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Creatives"> Creatives</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="audience_cb" value="Consumers" id="audience_cb_consumers"> Consumers</label>
        </div>
        <div id="consumer_age_wrap" class="intake-other-wrap" style="display: none; margin-top: 0.75rem;" data-consumer-age-field="true">
          <label for="consumer_age_range">What age range is your consumer audience?</label>
          <input type="text" id="consumer_age_range" name="consumer_age_range" placeholder="e.g. 18-24 or 30+" value="{{ existing_intake.get('consumer_age_range', '') }}" autocomplete="off">
        </div>
        <input type="text" id="audience_other" name="audience_other" placeholder="Other (e.g. coaches, agencies)" style="margin-top: 0.75rem;" value="">
        <input type="hidden" id="audience" name="audience" value="{{ existing_intake.get('audience', '') }}">
        <label for="audience_cares">What do they care about most when they land on your content?</label>
        <textarea id="audience_cares" name="audience_cares" placeholder="e.g. quick wins, feeling less overwhelmed, practical tips">{{ existing_intake.get('audience_cares', '') }}</textarea>
      </div>
      <div class="form-section">
        <h2>Voice</h2>
        <p class="field-helper" style="margin-bottom: 0.5rem;">Choose 3–5 words that describe how you want to sound (pick any that apply):</p>
        <div class="intake-checkbox-group" role="group" aria-label="Voice tone">
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="direct"> Direct</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="thoughtful"> Thoughtful</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="warm"> Warm</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="professional"> Professional</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="playful"> Playful</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="understated"> Understated</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="bold"> Bold</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="friendly"> Friendly</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="concise"> Concise</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="voice_words_cb" value="inspiring"> Inspiring</label>
        </div>
        <input type="text" id="voice_words_other" name="voice_words_other" placeholder="Other words (optional)" style="margin-top: 0.75rem;" value="">
        <input type="hidden" id="voice_words" name="voice_words" value="{{ existing_intake.get('voice_words', '') }}">
        <label for="voice_avoid">Is there any language or phrasing you want to avoid?</label>
        <textarea id="voice_avoid" name="voice_avoid" placeholder="e.g. jargon, hype, overly formal (optional)">{{ existing_intake.get('voice_avoid', '') }}</textarea>
      </div>
      <div class="form-section">
        <h2>Platform</h2>
        {% if platforms_count > 1 %}
        <p class="field-helper" style="margin-bottom: 0.5rem;">Select up to {{ platforms_count }} platforms (included in your order):</p>
        <div class="intake-checkbox-group" role="group" aria-label="Platforms">
          <label class="intake-checkbox-label"><input type="checkbox" name="platform_cb" value="Instagram & Facebook"> Instagram &amp; Facebook</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="platform_cb" value="LinkedIn"> LinkedIn</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="platform_cb" value="TikTok"> TikTok</label>
          <label class="intake-checkbox-label"><input type="checkbox" name="platform_cb" value="Pinterest"> Pinterest</label>
        </div>
        <input type="hidden" id="platform" name="platform" value="{{ prefilled_platform }}">
        {% else %}
        <label for="platform">Primary platform for these captions?</label>
        <select id="platform" name="platform">
          <option value="">— Select one —</option>
          <option value="Instagram & Facebook" {% if prefilled_platform == 'Instagram & Facebook' %}selected{% endif %}>Instagram &amp; Facebook</option>
          <option value="LinkedIn" {% if prefilled_platform == 'LinkedIn' %}selected{% endif %}>LinkedIn</option>
          <option value="TikTok" {% if prefilled_platform == 'TikTok' %}selected{% endif %}>TikTok</option>
          <option value="Pinterest" {% if prefilled_platform == 'Pinterest' %}selected{% endif %}>Pinterest</option>
        </select>
        {% endif %}
        <label for="platform_habits">Any platform-specific habits?</label>
        <input type="text" id="platform_habits" name="platform_habits" placeholder="e.g. shorter on Instagram, longer on LinkedIn (optional)" value="{{ existing_intake.get('platform_habits', '') }}">
      </div>
      <div class="form-section">
        <h2 style="display: flex; align-items: center;">Hashtags<span class="help-trigger" tabindex="0" role="button" aria-label="Hashtag guidelines"><span aria-hidden="true">?</span><span class="help-tooltip"><strong>Recommended by platform:</strong><br>Instagram &amp; Facebook 2–5 (or up to 30 on Instagram)<br>LinkedIn 2–5<br>TikTok 2–5<br>Pinterest 2–5<br><br>Quality over quantity. 3–10 is a safe range for most posts.</span></span></h2>
        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.5rem;">
          <input type="checkbox" id="include_hashtags" name="include_hashtags" {% if existing_intake.get('include_hashtags', True) %}checked{% endif %} style="width: auto;">
          <span>Include suggested hashtags with each caption</span>
        </label>
        <p style="font-size: 0.9rem; color: var(--lum-text-muted); margin-bottom: 1rem;">Uncheck if you prefer no hashtags (e.g. for a clean LinkedIn look).</p>
        <div id="hashtag-range-wrap" style="margin-top: 0.5rem;">
          <label for="hashtag_min">Minimum hashtags per caption</label>
          <input type="number" id="hashtag_min" name="hashtag_min" min="1" max="30" value="{{ existing_intake.get('hashtag_min', 3) }}" placeholder="3">
          <label for="hashtag_max">Maximum hashtags per caption</label>
          <input type="number" id="hashtag_max" name="hashtag_max" min="0" max="30" value="{{ existing_intake.get('hashtag_max', 10) }}" placeholder="10">
        </div>
      </div>
      <div class="form-section">
        <h2>Goal for this month</h2>
        <label for="goal">What's the main outcome you want from this 30 days?</label>
        <select id="goal" name="goal">
          <option value="">— Select one —</option>
          <option value="More inquiries / leads" {% if existing_intake.get('goal') == 'More inquiries / leads' %}selected{% endif %}>More inquiries / leads</option>
          <option value="Build authority" {% if existing_intake.get('goal') == 'Build authority' %}selected{% endif %}>Build authority</option>
          <option value="Launch visibility" {% if existing_intake.get('goal') == 'Launch visibility' %}selected{% endif %}>Launch visibility</option>
          <option value="Grow following" {% if existing_intake.get('goal') == 'Grow following' %}selected{% endif %}>Grow following</option>
          <option value="Consistent presence" {% if existing_intake.get('goal') == 'Consistent presence' %}selected{% endif %}>Consistent presence</option>
          <option value="Other" {% if existing_intake.get('goal') and existing_intake.get('goal') not in ['More inquiries / leads', 'Build authority', 'Launch visibility', 'Grow following', 'Consistent presence'] %}selected{% endif %}>Other</option>
        </select>
        <div id="goal_other_wrap" class="intake-other-wrap" style="display: none; margin-top: 0.5rem;">
          <label for="goal_other">Describe your goal</label>
          <input type="text" id="goal_other" name="goal_other" placeholder="e.g. build my email list, promote a new offer" value="{{ existing_intake.get('goal', '') if existing_intake.get('goal') and existing_intake.get('goal') not in ['More inquiries / leads', 'Build authority', 'Launch visibility', 'Grow following', 'Consistent presence'] else '' }}">
        </div>
      </div>
      <div class="form-section">
        <h2>Example captions (optional)</h2>
        <label for="caption_examples">Paste 1–3 example captions you like — from your own posts, competitors, or inspiration. We'll match this style, tone, and structure where relevant.</label>
        <textarea id="caption_examples" name="caption_examples" placeholder="Paste example captions here (optional)" style="min-height: 140px;">{{ existing_intake.get('caption_examples', '') }}</textarea>
      </div>
      <p id="intake-validation-hint" style="display: none; margin-bottom: 1rem; font-size: 0.9rem; color: #c00;"></p>
      <button type="button" class="btn-submit" id="btn-review">{% if existing_intake %}Review changes{% else %}Next step{% endif %}</button>
    </form>

    <div id="review-step" class="review-step">
      <h2 class="form-section" style="margin-bottom: 1rem;">Double-check your answers</h2>
      <p class="sub" style="margin-bottom: 1.5rem;">Review before sending. Click Edit to change anything.</p>
      <div id="review-content"></div>
      <div class="review-actions">
        <button type="button" class="btn-submit btn-secondary" id="btn-edit">Edit</button>
        <button type="button" class="btn-submit" id="btn-confirm">Send details</button>
      </div>
    </div>

    <p class="back"><a href="/captions">← Back to 30 Days Captions</a></p>
    {% endif %}
  </main>

  {% if intake_token %}
  <script>
    (function() {
      function runWhenReady(fn) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fn);
        } else {
          fn();
        }
      }
      runWhenReady(function() {
      var form = document.getElementById('captions-intake-form');
      var reviewStep = document.getElementById('review-step');
      var reviewContent = document.getElementById('review-content');
      var btnReview = document.getElementById('btn-review');
      var btnEdit = document.getElementById('btn-edit');
      var btnConfirm = document.getElementById('btn-confirm');
      if (!form || !reviewStep || !reviewContent || !btnReview) return;

      var platformsCount = parseInt(form.getAttribute('data-platforms-count') || '1', 10) || 1;
      function getVal(id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; }
      function getSelectOrOther(selectId, otherId) {
        var sel = document.getElementById(selectId);
        if (!sel) return '';
        var other = otherId ? document.getElementById(otherId) : null;
        if (sel.value === 'Other' && other) return other.value.trim();
        return sel.value.trim();
      }
      function syncAudience() {
        var checked = Array.prototype.slice.call(document.querySelectorAll('input[name="audience_cb"]:checked')).map(function(c) { return c.value; });
        var other = getVal('audience_other');
        var combined = checked.length ? checked.join(', ') : '';
        if (other) combined = combined ? combined + ', ' + other : other;
        var el = document.getElementById('audience');
        if (el) el.value = combined;
      }
      function syncVoiceWords() {
        var checked = Array.prototype.slice.call(document.querySelectorAll('input[name="voice_words_cb"]:checked')).map(function(c) { return c.value; });
        var other = getVal('voice_words_other');
        var combined = checked.length ? checked.join(', ') : '';
        if (other) combined = combined ? combined + ', ' + other : other;
        var el = document.getElementById('voice_words');
        if (el) el.value = combined;
      }
      function syncPlatforms() {
        var cbs = document.querySelectorAll('input[name="platform_cb"]');
        if (!cbs.length) return;
        var checked = Array.prototype.slice.call(cbs).filter(function(c) { return c.checked; });
        var parts = checked.map(function(c) { return c.value; }).filter(Boolean);
        var el = document.getElementById('platform');
        if (el) el.value = parts.join(', ');
      }
      function sect(t, v) {
        var p = document.createElement('p');
        p.textContent = v || '(not provided)';
        if (!v) p.className = 'empty';
        var h = document.createElement('h3');
        h.textContent = t;
        var div = document.createElement('div');
        div.className = 'review-section';
        div.appendChild(h);
        div.appendChild(p);
        return div;
      }
      function showReview() {
        var hintEl = document.getElementById('intake-validation-hint');
        if (hintEl) { hintEl.style.display = 'none'; hintEl.textContent = ''; }
        syncAudience();
        syncVoiceWords();
        if (document.querySelectorAll('input[name="platform_cb"]').length) syncPlatforms();
        if (!form.checkValidity()) {
          form.reportValidity();
          var firstInvalid = form.querySelector(':invalid');
          if (firstInvalid && firstInvalid.scrollIntoView) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          if (hintEl) { hintEl.textContent = 'Please complete the required fields above (e.g. business name).'; hintEl.style.display = 'block'; }
          return;
        }
        reviewContent.innerHTML = '';
        reviewContent.appendChild(sect('Business name', getVal('business_name')));
        reviewContent.appendChild(sect('Business type', getSelectOrOther('business_type', 'business_type_other') || '(not provided)'));
        reviewContent.appendChild(sect('What you offer', getVal('offer_one_line')));
        reviewContent.appendChild(sect('Primary audience', getVal('audience') || '(not provided)'));
        var ageRange = getVal('consumer_age_range');
        if (ageRange) reviewContent.appendChild(sect('Consumer age range', ageRange));
        reviewContent.appendChild(sect('What they care about', getVal('audience_cares')));
        reviewContent.appendChild(sect('Voice (3–5 words)', getVal('voice_words') || '(not provided)'));
        reviewContent.appendChild(sect('Language to avoid', getVal('voice_avoid')));
        reviewContent.appendChild(sect('Primary platform', getVal('platform') || '(not provided)'));
        reviewContent.appendChild(sect('Platform habits', getVal('platform_habits')));
        var incCb = document.getElementById('include_hashtags');
        var hashtags = incCb && incCb.checked ? 'Yes, ' + (getVal('hashtag_min') || '3') + '–' + (getVal('hashtag_max') || '10') + ' per caption' : 'No';
        reviewContent.appendChild(sect('Hashtags', hashtags));
        reviewContent.appendChild(sect('Goal for this month', getSelectOrOther('goal', 'goal_other') || '(not provided)'));
        reviewContent.appendChild(sect('Example captions', getVal('caption_examples')));
        form.style.display = 'none';
        reviewStep.classList.add('show');
      }
      function showForm() {
        reviewStep.classList.remove('show');
        form.style.display = 'block';
      }
      function submitForm() {
        syncAudience();
        syncVoiceWords();
        if (document.querySelectorAll('input[name="platform_cb"]').length) syncPlatforms();
        var incHashtags = document.getElementById('include_hashtags').checked;
        var minH = parseInt(document.getElementById('hashtag_min').value, 10) || 3;
        var maxH = parseInt(document.getElementById('hashtag_max').value, 10) || 10;
        if (minH > maxH) maxH = minH;
        var payload = {
          token: getVal('intake_token'),
          business_name: getVal('business_name'),
          business_type: getSelectOrOther('business_type', 'business_type_other'),
          offer_one_line: getVal('offer_one_line'),
          audience: getVal('audience'),
          consumer_age_range: getVal('consumer_age_range'),
          audience_cares: getVal('audience_cares'),
          voice_words: getVal('voice_words'),
          voice_avoid: getVal('voice_avoid'),
          platform: getVal('platform'),
          platform_habits: getVal('platform_habits'),
          include_hashtags: incHashtags,
          hashtag_min: minH,
          hashtag_max: maxH,
          goal: getSelectOrOther('goal', 'goal_other'),
          caption_examples: getVal('caption_examples')
        };
        btnConfirm.disabled = true;
        btnConfirm.textContent = 'Sending…';
        fetch('/api/captions-intake', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json().then(function(j) { return { status: r.status, json: j }; }); })
        .then(function(result) {
          if (result.status === 200 && result.json.success) {
            reviewStep.classList.remove('show');
            var successEl = document.getElementById('intake-success');
            successEl.style.display = 'block';
            var msgEl = document.getElementById('intake-success-msg');
            if (msgEl && result.json.message) msgEl.textContent = result.json.message;
            var custEmail = (result.json.customer_email || '').trim();
            document.getElementById('ca-email').value = custEmail;
          } else {
            document.getElementById('intake-error').textContent = result.json.error || 'Something didn't send — try again or email us at hello@lumo22.com.';
            document.getElementById('intake-error').style.display = 'block';
            btnConfirm.disabled = false;
            btnConfirm.textContent = 'Send details';
          }
        })
        .catch(function() {
          document.getElementById('intake-error').textContent = 'Something didn't send — try again or email hello@lumo22.com.';
          document.getElementById('intake-error').style.display = 'block';
          btnConfirm.disabled = false;
          btnConfirm.textContent = 'Send details';
        });
      }

      btnReview.addEventListener('click', function() { try { showReview(); } catch (e) { if (typeof console !== 'undefined' && console.error) console.error('Next step:', e); } });
      if (btnEdit) btnEdit.addEventListener('click', showForm);
      if (btnConfirm) btnConfirm.addEventListener('click', submitForm);

      (function goalOtherToggle() {
        var goalSelect = document.getElementById('goal');
        var goalWrap = document.getElementById('goal_other_wrap');
        if (!goalSelect || !goalWrap) return;
        function showHide() {
          goalWrap.style.display = goalSelect.value === 'Other' ? 'block' : 'none';
        }
        goalSelect.addEventListener('change', showHide);
        showHide();
      })();

      (function consumerAgeToggle() {
        var consumersCb = document.getElementById('audience_cb_consumers');
        var wrap = document.getElementById('consumer_age_wrap');
        if (!consumersCb || !wrap) return;
        function showHide() {
          var show = consumersCb.checked;
          wrap.style.display = show ? 'block' : 'none';
          wrap.setAttribute('aria-hidden', show ? 'false' : 'true');
        }
        consumersCb.addEventListener('change', showHide);
        consumersCb.addEventListener('click', function() { setTimeout(showHide, 0); });
        var ageInput = document.getElementById('consumer_age_range');
        if (ageInput && ageInput.value.trim()) {
          consumersCb.checked = true;
          showHide();
        } else {
          showHide();
        }
      })();

      try {

      function toggleHashtagRange() {
        var wrap = document.getElementById('hashtag-range-wrap');
        var cb = document.getElementById('include_hashtags');
        if (wrap && cb) wrap.style.display = cb.checked ? '' : 'none';
      }
      var includeHashtags = document.getElementById('include_hashtags');
      if (includeHashtags) { includeHashtags.addEventListener('change', toggleHashtagRange); toggleHashtagRange(); }

      function toggleOtherFields() {
        var bt = document.getElementById('business_type');
        var bto = document.getElementById('business_type_other');
        if (bt && bto) bto.style.display = bt.value === 'Other' ? 'block' : 'none';
        var goalSelect = document.getElementById('goal');
        var goalOtherWrap = document.getElementById('goal_other_wrap');
        if (goalSelect && goalOtherWrap) {
          goalOtherWrap.style.display = goalSelect.value === 'Other' ? 'block' : 'none';
          goalOtherWrap.setAttribute('aria-hidden', goalSelect.value === 'Other' ? 'false' : 'true');
        }
      }
      ['business_type', 'goal'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', toggleOtherFields);
      });
      toggleOtherFields();
      (function setupMultiPlatform() {
        var cbs = document.querySelectorAll('input[name="platform_cb"]');
        if (!cbs.length) return;
        cbs.forEach(function(cb) {
          cb.addEventListener('change', function() {
            var checked = document.querySelectorAll('input[name="platform_cb"]:checked');
            if (checked.length > platformsCount && this.checked) this.checked = false;
            syncPlatforms();
          });
        });
        var platformVal = getVal('platform');
        if (platformVal) {
          var parts = platformVal.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
          var known = ['Instagram & Facebook', 'LinkedIn', 'TikTok', 'Pinterest'];
          parts.forEach(function(p) {
            cbs.forEach(function(cb) {
              if (cb.value === p) cb.checked = true;
            });
          });
        }
        syncPlatforms();
      })();
      function toggleConsumerAge() {
        var consumersCb = document.getElementById('audience_cb_consumers');
        var wrap = document.getElementById('consumer_age_wrap');
        if (wrap && consumersCb) {
          wrap.style.display = consumersCb.checked ? 'block' : 'none';
          wrap.setAttribute('aria-hidden', consumersCb.checked ? 'false' : 'true');
        }
      }
      var consumersCb = document.getElementById('audience_cb_consumers');
      if (consumersCb) {
        consumersCb.addEventListener('change', toggleConsumerAge);
        consumersCb.addEventListener('click', function() { setTimeout(toggleConsumerAge, 0); });
      }
      if (getVal('consumer_age_range') && consumersCb) {
        consumersCb.checked = true;
        toggleConsumerAge();
      } else {
        toggleConsumerAge();
      }
      document.querySelectorAll('input[name="audience_cb"], #audience_other').forEach(function(el) { el.addEventListener('change', syncAudience); el.addEventListener('input', syncAudience); });
      document.querySelectorAll('input[name="voice_words_cb"], #voice_words_other').forEach(function(el) { el.addEventListener('change', syncVoiceWords); el.addEventListener('input', syncVoiceWords); });
      (function prefillCheckboxes() {
        var aud = getVal('audience');
        if (aud) {
          var parts = aud.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
          var otherParts = [];
          parts.forEach(function(p) {
            var cbs = document.querySelectorAll('input[name="audience_cb"]');
            var found = false;
            for (var i = 0; i < cbs.length; i++) { if (cbs[i].value === p) { cbs[i].checked = true; found = true; break; } }
            if (!found) otherParts.push(p);
          });
          var otherEl = document.getElementById('audience_other');
          if (otherEl && otherParts.length) otherEl.value = otherParts.join(', ');
        }
        var vw = getVal('voice_words');
        if (vw) {
          var parts = vw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
          var otherParts = [];
          parts.forEach(function(p) {
            var cbs = document.querySelectorAll('input[name="voice_words_cb"]');
            var found = false;
            for (var i = 0; i < cbs.length; i++) { if (cbs[i].value.toLowerCase() === p.toLowerCase()) { cbs[i].checked = true; found = true; break; } }
            if (!found) otherParts.push(p);
          });
          var otherEl = document.getElementById('voice_words_other');
          if (otherEl && otherParts.length) otherEl.value = otherParts.join(', ');
        }
        syncAudience();
        syncVoiceWords();
        toggleConsumerAge();
      })();

      } catch (e) { if (typeof console !== 'undefined' && console.error) console.error('Intake setup:', e); }

      var caForm = document.getElementById('create-account-form');
      if (caForm) {
        caForm.addEventListener('submit', function(e) {
          e.preventDefault();
          var email = document.getElementById('ca-email').value.trim();
          var pw = document.getElementById('ca-password').value;
          if (!email) { alert('Just need your email to continue.'); return; }
          if (pw.length < 6) { alert('Password must be at least 6 characters.'); return; }
          var btn = document.getElementById('ca-btn');
          btn.disabled = true;
          btn.textContent = 'Creating…';
          fetch('/api/auth/create-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email.toLowerCase(), password: pw })
          })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.ok) {
              document.getElementById('create-account-form').style.display = 'none';
              document.getElementById('ca-done').style.display = 'block';
            } else {
              alert(data.error || 'Something didn\'t go through — try again.');
              btn.disabled = false;
              btn.textContent = 'Create account';
            }
          })
          .catch(function() {
            alert('Something didn\'t send — try again.');
            btn.disabled = false;
            btn.textContent = 'Create account';
          });
        });
      }
      }); // end runWhenReady
    })();
  </script>
  {% endif %}
  {% include '_footer.html' %}
</body>
</html>
