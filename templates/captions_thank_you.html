<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thank you for your order | Lumo 22</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <meta name="description" content="Thanks for ordering 30 Days of Social Media Captions. Complete the short form to receive your captions.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}?v={{ asset_version }}">
  <style>
    .thankyou-section { padding-top: 8rem; padding-bottom: 4rem; }
    .thankyou-card { max-width: 520px; margin: 0 auto; padding: 2.5rem; background: var(--lum-card-bg, rgba(255,255,255,0.03)); border-radius: 12px; border: 1px solid var(--lum-border, rgba(255,255,255,0.08)); }
    .thankyou-card h1 { font-family: var(--font-display); font-size: 1.75rem; margin-bottom: 1rem; }
    .thankyou-card p { color: var(--lum-text-muted); line-height: 1.7; margin-bottom: 1.25rem; }
    .thankyou-card .thankyou-cta { margin-top: 1.5rem; display: inline-block; }
    .thankyou-card .thankyou-back { margin-top: 2rem; }
    .thankyou-card .thankyou-back a { color: var(--lum-text-muted); text-decoration: none; font-size: 0.95rem; }
    .thankyou-card .thankyou-back a:hover { color: var(--lum-text); }
    .thankyou-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--lum-text-muted); border-top-color: transparent; border-radius: 50%; animation: thankyou-spin 0.8s linear infinite; vertical-align: middle; margin-right: 0.5rem; }
    @keyframes thankyou-spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="lumo-landing">
  <nav class="lumo-nav lumo-nav-scrolled">
    <a href="/" class="lumo-nav-logo">Lumo 22</a>
    <div class="lumo-nav-links">
      <a href="/captions">Captions</a>
    </div>
    {% if current_customer %}<a href="/account" class="lumo-nav-cta">Account</a>{% else %}<a href="/login" class="lumo-nav-cta lumo-nav-login">Log in</a>{% endif %}
  </nav>

  <!-- Same thank-you page for captions one-off and subscription; intake link is polled via session_id. No template vars required. -->
  <section class="lumo-section thankyou-section">
    <div class="lumo-section-header">
      <p class="lumo-section-label">Order confirmed</p>
      <h1 class="lumo-section-title">Thanks for your order</h1>
    </div>
    <div class="thankyou-card" id="thankyou-box">
      <h1>30 Days of Social Media Captions</h1>
      <p id="thankyou-message">We've received your payment. One moment — we're preparing your next step…</p>
      <p id="thankyou-form-link" style="display: none;">
        <a href="#" id="intake-link" class="lumo-btn-primary thankyou-cta">Complete your details</a>
        <span id="thankyou-redirect-msg" style="display: block; margin-top: 0.75rem; font-size: 0.9rem; color: var(--lum-text-muted);"></span>
      </p>
      <p id="thankyou-email-fallback" style="display: none;">We've also sent the link by email — use it anytime to open the form.</p>
      <p id="thankyou-no-session" style="display: none;">Check your email for a link to the short form. After you submit, we'll create your 30 captions and deliver by email.</p>
      <p class="thankyou-back"><a href="/captions">← Back to Captions</a> · <a href="/">Lumo 22 home</a></p>
    </div>
  </section>

  {% include '_footer.html' %}

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var sessionId = params.get('session_id');
      var messageEl = document.getElementById('thankyou-message');
      var formLinkEl = document.getElementById('thankyou-form-link');
      var intakeLinkEl = document.getElementById('intake-link');
      var emailFallbackEl = document.getElementById('thankyou-email-fallback');
      var noSessionEl = document.getElementById('thankyou-no-session');

      if (!sessionId) {
        messageEl.style.display = 'none';
        noSessionEl.style.display = 'block';
        noSessionEl.innerHTML = 'Check your email for a link to the form. After you submit, we\'ll create your 30 captions and deliver by email.<br><br>Questions? <a href="mailto:hello@lumo22.com">hello@lumo22.com</a>';
        return;
      }

      var REDIRECT_DELAY_MS = 5000; // Stay on thank-you page 5 seconds before auto-redirect
      var redirectMsgEl = document.getElementById('thankyou-redirect-msg');

      function showIntake(url) {
        messageEl.textContent = "Your form is ready. Click below to share your business and voice — we'll then create your 30 captions.";
        messageEl.style.display = 'block';
        intakeLinkEl.href = url;
        formLinkEl.style.display = 'block';
        emailFallbackEl.style.display = 'block';
        var secondsLeft = Math.ceil(REDIRECT_DELAY_MS / 1000);
        var countdown = setInterval(function() {
          redirectMsgEl.textContent = secondsLeft > 0 ? "We'll take you there in " + secondsLeft + " second" + (secondsLeft === 1 ? "" : "s") + "…" : "";
          secondsLeft--;
          if (secondsLeft < 0) clearInterval(countdown);
        }, 1000);
        setTimeout(function() {
          clearInterval(countdown);
          window.location.href = url;
        }, REDIRECT_DELAY_MS);
      }

      function check() {
        fetch('/api/captions-intake-link?session_id=' + encodeURIComponent(sessionId))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.status === 'ok' && data.intake_url) {
              showIntake(data.intake_url);
            }
          })
          .catch(function() {});
      }

      check();
      var interval = setInterval(function() {
        fetch('/api/captions-intake-link?session_id=' + encodeURIComponent(sessionId))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.status === 'ok' && data.intake_url) {
              clearInterval(interval);
              showIntake(data.intake_url);
            }
          })
          .catch(function() {});
      }, 2000);
      setTimeout(function() { clearInterval(interval); }, 30000);
    })();
  </script>
</body>
</html>
