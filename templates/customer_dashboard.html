<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Account | Lumo 22</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <meta name="description" content="Manage your Lumo 22 account: Captions and settings.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Encode+Sans+Condensed:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}?v={{ asset_version }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}?v={{ asset_version }}">
</head>
<body class="lumo-landing account-page-wrap">
  <nav class="lumo-nav" id="lumo-nav">
    <a href="/" class="lumo-nav-logo">Lumo 22</a>
    <div class="lumo-nav-links">
      <a href="/captions">Captions</a>
    </div>
    <form action="/api/auth/logout" method="POST" style="margin: 0; display: inline;">
      <button type="submit" class="lumo-nav-cta account-nav-logout-btn">Log out</button>
    </form>
  </nav>

  <div class="account-layout">
    <aside class="account-sidebar">
      <h1 class="account-sidebar-title">Your account</h1>
      <ul class="account-sidebar-nav">
        <li><a href="/account/information" class="{% if current_section == 'information' %}active{% endif %}">Account Information</a></li>
        <li><a href="/account/history" class="{% if current_section == 'history' %}active{% endif %}">History</a></li>
        <li><a href="/account/edit-form" class="{% if current_section == 'edit-form' %}active{% endif %}">Edit form</a></li>
        <li><a href="/account/pause" class="{% if current_section == 'pause' %}active{% endif %}">Manage subscription</a></li>
        <li><a href="/account/refer" class="{% if current_section == 'refer' %}active{% endif %}">Refer a friend</a></li>
      </ul>
      <div class="account-sidebar-logout">
        <form action="/api/auth/logout" method="POST" style="margin: 0;">
          <button type="submit" class="dfd-btn dfd-btn-secondary">Log out</button>
        </form>
      </div>
    </aside>

    <main class="account-main{% if current_section == 'history' %} account-main--wide{% endif %}">
      {% if current_section == 'information' %}
      {% if request.args.get('billing') == 'no_sub' %}
      <div class="account-info-panel" style="margin-bottom: 1rem; background: rgba(255,200,0,0.1); border-color: rgba(255,200,0,0.3);">
        <p style="margin: 0; color: #333;">No subscription found. If you're on the monthly plan, use the link in your order emails to manage billing.</p>
      </div>
      {% elif request.args.get('billing') == 'error' %}
      <div class="account-info-panel" style="margin-bottom: 1rem; background: rgba(200,80,80,0.08); border-color: rgba(200,80,80,0.25);">
        <p style="margin: 0; color: #333;">Could not open billing portal. Please try again or email hello@lumo22.com.</p>
      </div>
      {% endif %}

      <section class="account-section-block">
        <h2>Account Information</h2>
        <p class="account-section-desc">Update your email, password, and billing securely below.</p>
        <div class="account-info-panel">
          <div class="account-info-row">
            <div>
              <span class="account-info-label">Email</span>
              <div class="account-info-value">{{ customer.email }}</div>
            </div>
          </div>
          <div class="account-info-row">
            <div>
              <span class="account-info-label">Password</span>
              <div class="account-info-value">••••••••</div>
            </div>
            <div class="account-info-actions">
              <a href="/forgot-password">Change password</a>
            </div>
          </div>
          <div class="account-info-row">
            <div>
              <span class="account-info-label">Billing</span>
              <div class="account-info-value">Payment method and invoices</div>
            </div>
            <div class="account-info-actions">
              <a href="/api/billing/portal">Manage billing</a>
            </div>
          </div>
          <div class="account-info-row">
            <div>
              <span class="account-info-label">Marketing emails</span>
              <div class="account-info-value">Tips, updates, and offers from Lumo 22</div>
            </div>
            <div id="marketing-toggle-wrap" role="button" tabindex="0" class="account-toggle {% if customer.get('marketing_opt_in', True) %}on{% endif %}" aria-label="Toggle marketing emails" onclick="toggleMarketing()" onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleMarketing(); }"></div>
          </div>
          <div class="account-info-row account-info-row--delete">
            <div>
              <span class="account-info-label">Delete account</span>
              <div class="account-info-value">Permanently delete your account and associated data. This cannot be undone.</div>
            </div>
            <div class="account-info-actions">
              <form id="account-delete-form" action="/api/auth/delete-account" method="POST" class="account-delete-form" style="margin: 0; display: inline;">
                <button type="button" class="account-delete-account-btn" id="account-delete-trigger">Delete account</button>
              </form>
            </div>
          </div>
        </div>
      </section>
      {% endif %}

      {% if current_section == 'history' %}
      <section class="account-section-block">
        <h2>History</h2>
        {% set delivered_orders = (caption_orders|selectattr('status', 'equalto', 'delivered')|list)|sort(attribute='created_at', reverse=True) %}
        {% if delivered_orders %}
        <p class="account-section-desc">View or download your previous packs. Each pack is available as a PDF; if you added Story Ideas, you get a separate Stories PDF.</p>
        <div class="account-history-list">
          {% for o in delivered_orders %}
          <div class="account-history-item" data-history-token="{{ o.token }}">
            {% set biz = (o.get('intake') or {}).get('business_name', '')|trim %}
            {% set is_sub = (o.get('stripe_subscription_id') or '')|trim %}
            {% set label = biz if biz else ('Subscription' if is_sub else 'One-off') %}
            <span>{{ label }} — Pack {{ o.created_at[:10] if o.created_at else '—' }}</span>
            <span class="account-history-type account-history-type--{{ 'subscription' if is_sub else 'oneoff' }}">{{ 'Subscription' if is_sub else 'One-off' }}</span>
            <div class="account-history-actions">
              <a href="/api/captions-download?t={{ o.token }}&inline=1" target="_blank" rel="noopener" class="account-btn-link account-btn-link--primary">View captions</a>
              <a href="/api/captions-download?t={{ o.token }}" class="account-btn-link account-btn-link--secondary">Download captions PDF</a>
              {% if o.include_stories %}
              <a href="/api/captions-download?t={{ o.token }}&type=stories&inline=1" target="_blank" rel="noopener" class="account-btn-link account-btn-link--primary">View Stories</a>
              <a href="/api/captions-download?t={{ o.token }}&type=stories" class="account-btn-link account-btn-link--secondary">Download Stories PDF</a>
              {% endif %}
              <button type="button" class="account-btn-link account-history-delete" data-token="{{ o.token }}" onclick="deletePackFromHistory(this)" aria-label="Delete pack from history">Delete</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="account-section-desc">No delivered packs yet. When your first pack is ready, it will appear here with view and download options.</p>
        <p><a href="/captions" style="color: #8b6914; font-weight: 500;">Get 30 Days Captions</a></p>
        {% endif %}
      </section>
      {% endif %}

      {% if current_section == 'edit-form' %}
      <section class="account-section-block">
        <h2>Edit form</h2>
        {% set edit_form_orders = caption_orders|selectattr('stripe_subscription_id')|list if caption_orders else [] %}
        {% if not edit_form_orders and current_intake_order %}
          {% set edit_form_orders = [current_intake_order] %}
        {% endif %}
        {% if edit_form_orders %}
        <p class="account-section-desc">Update your voice, topics, and preferences. Changes are reflected in your <strong>next</strong> captions and stories pack, not in packs already delivered. Edits are free; adding Story Ideas or extra platforms may require an additional charge. Select the form by business to edit.</p>
        <ul class="account-edit-form-list">
          {% for o in edit_form_orders %}
          {% set biz = (o.get('intake') or {}).get('business_name', '') %}
          {% set label = biz if biz else (o.created_at[:10] if o.created_at else 'Subscription') %}
          <li>
            {% if o.status == 'awaiting_intake' %}
            <a href="/captions-intake?t={{ o.token }}">Complete the form — {{ label }}</a>
            {% else %}
            <a href="/captions-intake?t={{ o.token }}">Edit form — {{ label }}</a>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="account-section-desc">No caption orders yet. After you purchase, you can edit your intake form here.</p>
        <p><a href="/captions" style="color: #8b6914; font-weight: 500;">Get 30 Days Captions</a></p>
        {% endif %}
      </section>
      {% endif %}

      {% if current_section == 'pause' %}
      <section class="account-section-block">
        <h2>Manage subscription</h2>
        {% set sub_orders = caption_orders|selectattr('stripe_subscription_id')|list if caption_orders else [] %}
        {% if sub_orders %}
        <p class="account-section-desc">Cancel your subscription, update your billing info, or view invoices in Stripe’s secure portal. You can use a different card for each subscription below. Add or update cards via Manage billing, then choose which card to use for each. Below you can also pause billing for one month and manage intake reminders.</p>
        <p style="margin-bottom: 1.25rem;"><a href="/api/billing/portal" class="account-billing-portal-link">Manage billing</a></p>
        {% for o in sub_orders %}
        {% set pause_biz = (o.get('intake') or {}).get('business_name', '') %}
        {% set pause_label = pause_biz if pause_biz else (o.created_at[:10] if o.created_at else 'Subscription') %}
        {% set sub_id = (o.get('stripe_subscription_id') or '')|trim %}
        {% set current_pm = (subscription_billing.subscription_payment_methods.get(sub_id) if subscription_billing else None) %}
        <div class="account-pause-block" style="margin-bottom: 1rem;">
          <div class="account-pause-panel-title" style="font-size: 0.9rem; font-weight: 600; color: #000; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.08);">{{ pause_label }}</div>
          <div class="account-settings-row account-payment-method-row" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid rgba(0,0,0,0.06);" data-subscription-id="{{ sub_id }}">
            <div>
              <div class="account-settings-label" style="font-size: 0.95rem; font-weight: 600; color: #000;">Payment method</div>
              <div class="account-settings-desc account-payment-method-display">{% if current_pm %}{{ current_pm.brand }} ****{{ current_pm.last4 }}{% else %}—{% endif %}</div>
            </div>
            <div class="account-payment-method-select-wrap">
              {% if subscription_billing and subscription_billing.payment_methods %}
              <select class="account-payment-method-select" aria-label="Choose card for this subscription" data-subscription-id="{{ sub_id }}">
                {% for pm in subscription_billing.payment_methods %}
                <option value="{{ pm.id }}" {% if current_pm and current_pm.id == pm.id %}selected{% endif %}>{{ pm.brand }} ****{{ pm.last4 }}</option>
                {% endfor %}
              </select>
              {% else %}
              <span class="account-payment-method-no-cards">Add a card via <a href="/api/billing/portal">Manage billing</a></span>
              {% endif %}
            </div>
          </div>
          <div class="account-settings-row" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <div>
              <div class="account-settings-label" style="font-size: 0.95rem; font-weight: 600; color: #000;">Intake reminders</div>
              <div class="account-settings-desc">Email me before each pack so I can update my intake</div>
            </div>
            <div id="reminder-toggle-{{ o.id }}" role="button" tabindex="0" class="account-toggle {% if not o.reminder_opt_out %}on{% endif %}" aria-label="Toggle intake reminders" data-order-id="{{ o.id }}" onclick="toggleReminder(this)" onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleReminder(this); }"></div>
          </div>
          <div class="account-settings-row" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <div>
              <div class="account-settings-label" style="font-size: 0.95rem; font-weight: 600; color: #000;">Pause subscription</div>
              <div class="account-settings-desc">{% if o.subscription_pause and o.subscription_pause.paused %}Paused — resumes {{ o.subscription_pause.resumes_at or 'automatically' }}{% else %}Pause billing for 1 month (no charge, no pack){% endif %}</div>
            </div>
            {% if o.subscription_pause and o.subscription_pause.paused %}
            <span class="account-pause-badge" style="font-size: 0.85rem; font-weight: 500; color: #555; padding: 0.35rem 0.75rem; background: rgba(0,0,0,0.06); border-radius: 12px;">Paused</span>
            {% else %}
            <button type="button" class="dfd-btn dfd-btn-secondary account-pause-btn" data-order-id="{{ o.id }}" onclick="pauseSubscription(this)">Pause for 1 month</button>
            {% endif %}
          </div>
          {% if not o.get('include_stories') %}
          <div class="account-settings-row account-add-stories-row" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; padding: 1rem 0; border-bottom: none;">
            <div>
              <div class="account-settings-label" style="font-size: 0.95rem; font-weight: 600; color: #000;">Story Ideas</div>
              <div class="account-settings-desc">Add 30 Days Story Ideas to this subscription. You'll be charged a prorated amount. Stories will be delivered with your <strong>next</strong> set of captions, not instantly.</div>
            </div>
            <button type="button" class="account-add-stories-btn dfd-btn dfd-btn-secondary" data-subscription-id="{{ sub_id }}" onclick="addStoriesToSubscription(this)">Add Story Ideas</button>
          </div>
          {% else %}
          <div class="account-settings-row" style="padding: 1rem 0; border-bottom: none;">
            <div class="account-settings-label" style="font-size: 0.95rem; font-weight: 600; color: #000;">Story Ideas</div>
            <div class="account-settings-desc">Included in this subscription. You'll receive Stories with each pack.</div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p class="account-section-desc">You don't have an active subscription. Pause is only available for monthly Captions subscribers.</p>
        <p><a href="/captions" style="color: #8b6914; font-weight: 500;">View 30 Days Captions</a></p>
        {% endif %}
      </section>
      {% endif %}

      {% if current_section == 'refer' %}
      <section class="account-section-block">
        <h2>Refer a friend</h2>
        {% if referral_code %}
        <p class="account-section-desc">Share your referral link — when friends sign up, they'll use your code.</p>
        <div class="account-referral-block">
          <label class="account-settings-label" for="referral-link">Your referral link</label>
          <div class="referral-row" style="display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
            <input type="text" id="referral-link" readonly value="{{ base_url }}/signup?ref={{ referral_code }}" class="referral-input" style="flex: 1; padding: 0.6rem 0.9rem; font-size: 0.9rem; border: 1px solid rgba(0,0,0,0.15); border-radius: 12px; background: #f8f8f6; color: #111;">
            <button type="button" class="dfd-btn dfd-btn-secondary referral-copy" onclick="copyReferralLink()">Copy link</button>
          </div>
          <p class="account-settings-desc" style="margin-top: 0.5rem; color: #444;">Or share your code: <strong>{{ referral_code }}</strong></p>
        {% if referral_discount_credits|default(0) > 0 %}
        <p class="account-settings-desc" style="margin-top: 0.75rem; color: var(--lum-gold); font-weight: 600;">You have {{ referral_discount_credits }} referral credit{{ 's' if referral_discount_credits != 1 else '' }} — 10% off your next {{ referral_discount_credits }} billing period{{ 's' if referral_discount_credits != 1 else '' }}.</p>
        {% endif %}
        </div>
        {% else %}
        <p class="account-section-desc">Referral codes are available for active customers. Make a purchase to get your unique link.</p>
        {% endif %}
      </section>
      {% endif %}
    </main>

    <div id="account-delete-modal" class="account-delete-modal" role="dialog" aria-labelledby="account-delete-modal-title" aria-modal="true" hidden>
      <div class="account-delete-modal-backdrop"></div>
      <div class="account-delete-modal-box">
        <h2 id="account-delete-modal-title" class="account-delete-modal-title">Delete account?</h2>
        <p class="account-delete-modal-text">Are you sure you want to delete your account? All your information and past PDFs will be deleted.</p>
        <div class="account-delete-modal-type-wrap">
          <label for="account-delete-type-input" class="account-delete-modal-type-label">Type DELETE to confirm</label>
          <input type="text" id="account-delete-type-input" class="account-delete-modal-type-input" placeholder="DELETE" autocomplete="off" aria-describedby="account-delete-type-hint">
          <span id="account-delete-type-hint" class="account-delete-modal-type-hint">The confirm button will enable when you type DELETE.</span>
        </div>
        <div class="account-delete-modal-buttons">
          <a href="/account/pause" class="account-delete-modal-btn account-delete-modal-cancel-sub">Cancel subscription instead</a>
          <button type="button" class="account-delete-modal-btn account-delete-modal-keep">Keep account</button>
          <button type="button" class="account-delete-modal-btn account-delete-modal-confirm" disabled>Confirm account deletion</button>
        </div>
      </div>
    </div>
  </div>

  {% include '_footer.html' %}

  <script src="{{ url_for('static', filename='js/landing.js') }}?v={{ asset_version }}"></script>
  <script>
    (function() {
      if (window.location.search.indexOf('login_token=') !== -1) {
        try { history.replaceState({}, '', window.location.pathname); } catch (e) {}
      }
      var logoutForms = document.querySelectorAll('form[action="/api/auth/logout"]');
      logoutForms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!confirm('Are you sure you want to log out?')) return;
          fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' })
            .then(function() { window.location.href = '/'; })
            .catch(function() { window.location.href = '/'; });
        });
      });
      var deleteModal = document.getElementById('account-delete-modal');
      var deleteTrigger = document.getElementById('account-delete-trigger');
      var deleteForm = document.getElementById('account-delete-form');
      var deleteTypeInput = document.getElementById('account-delete-type-input');
      function openDeleteModal() {
        if (deleteModal) {
          if (deleteTypeInput) { deleteTypeInput.value = ''; deleteTypeInput.focus(); }
          var confirmBtn = deleteModal.querySelector('.account-delete-modal-confirm');
          if (confirmBtn) confirmBtn.disabled = true;
          deleteModal.removeAttribute('hidden');
          deleteModal.classList.add('account-delete-modal--open');
        }
      }
      function closeDeleteModal() {
        if (deleteModal) {
          deleteModal.setAttribute('hidden', '');
          deleteModal.classList.remove('account-delete-modal--open');
        }
      }
      if (deleteTrigger) deleteTrigger.addEventListener('click', openDeleteModal);
      if (deleteModal) {
        var backdrop = deleteModal.querySelector('.account-delete-modal-backdrop');
        var keepBtn = deleteModal.querySelector('.account-delete-modal-keep');
        var confirmBtn = deleteModal.querySelector('.account-delete-modal-confirm');
        if (backdrop) backdrop.addEventListener('click', closeDeleteModal);
        if (keepBtn) keepBtn.addEventListener('click', closeDeleteModal);
        if (confirmBtn && deleteForm) confirmBtn.addEventListener('click', function() { if (!this.disabled) deleteForm.submit(); });
        if (deleteTypeInput && confirmBtn) {
          deleteTypeInput.addEventListener('input', function() {
            confirmBtn.disabled = deleteTypeInput.value.trim().toLowerCase() !== 'delete';
          });
        }
      }

      function toggleMarketing() {
        var wrap = document.getElementById('marketing-toggle-wrap');
        if (!wrap) return;
        var optIn = wrap.classList.contains('on');
        var nextOptIn = !optIn;
        wrap.classList.toggle('on', nextOptIn);
        fetch('/api/auth/preferences', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ marketing_opt_in: nextOptIn })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.ok) { wrap.classList.toggle('on', optIn); }
        })
        .catch(function() { wrap.classList.toggle('on', optIn); });
      }

      function toggleReminder(el) {
        var wrap = el;
        var orderId = wrap.getAttribute('data-order-id');
        if (!orderId) return;
        var isOn = wrap.classList.contains('on');
        var nextOptOut = isOn;
        fetch('/api/captions/reminder-preference', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderId, reminder_opt_out: nextOptOut })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) wrap.classList.toggle('on', !nextOptOut);
        })
        .catch(function() {});
      }

      function copyReferralLink() {
        var input = document.getElementById('referral-link');
        if (!input) return;
        input.select();
        input.setSelectionRange(0, 99999);
        try {
          navigator.clipboard.writeText(input.value);
          var btn = document.querySelector('.referral-copy');
          if (btn) { btn.textContent = 'Copied!'; setTimeout(function() { btn.textContent = 'Copy link'; }, 2000); }
        } catch (e) {}
      }

      function pauseSubscription(btn) {
        var orderId = btn.getAttribute('data-order-id');
        if (!orderId) return;
        btn.disabled = true;
        btn.textContent = 'Pausing…';
        fetch('/api/captions/pause-subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderId })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            window.location.reload();
          } else {
            alert(data.error || 'Could not pause subscription');
            btn.disabled = false;
            btn.textContent = 'Pause for 1 month';
          }
        })
        .catch(function() {
          alert('Something went wrong — try again.');
          btn.disabled = false;
          btn.textContent = 'Pause for 1 month';
        });
      }

      function deletePackFromHistory(btn) {
        if (!btn) return;
        var token = btn.getAttribute('data-token');
        if (!token) return;
        if (!confirm('Are you sure you want to delete this pack from your history? Once deleted, it cannot be undone.')) return;
        btn.disabled = true;
        btn.textContent = 'Deleting…';
        fetch('/api/captions/hide-pack', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token }),
          credentials: 'same-origin'
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            var item = btn.closest('.account-history-item');
            if (item) item.remove();
            else window.location.reload();
          } else {
            alert(data.error || 'Could not delete pack');
            btn.disabled = false;
            btn.textContent = 'Delete';
          }
        })
        .catch(function() {
          alert('Something went wrong — try again.');
          btn.disabled = false;
          btn.textContent = 'Delete';
        });
      }
      window.deletePackFromHistory = deletePackFromHistory;

      function addStoriesToSubscription(btn) {
        var subId = btn.getAttribute('data-subscription-id');
        if (!subId) return;
        btn.disabled = true;
        btn.textContent = 'Adding…';
        fetch('/api/billing/add-stories-to-subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subscription_id: subId }),
          credentials: 'same-origin'
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            alert(data.message || 'Story Ideas added. Stories will be included in your next pack.');
            window.location.reload();
          } else {
            alert(data.error || 'Could not add Story Ideas');
            btn.disabled = false;
            btn.textContent = 'Add Story Ideas';
          }
        })
        .catch(function() {
          alert('Something went wrong — try again.');
          btn.disabled = false;
          btn.textContent = 'Add Story Ideas';
        });
      }

      function changeSubscriptionPaymentMethod(selectEl) {
        if (!selectEl) return;
        var subId = selectEl.getAttribute('data-subscription-id');
        var pmId = selectEl.value;
        if (!subId || !pmId) return;
        var row = selectEl.closest('.account-payment-method-row');
        var displayEl = row ? row.querySelector('.account-payment-method-display') : null;
        var opt = selectEl.options[selectEl.selectedIndex];
        var label = opt ? opt.textContent : '';
        selectEl.disabled = true;
        fetch('/api/billing/subscription-payment-method', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subscription_id: subId, payment_method_id: pmId }),
          credentials: 'same-origin'
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          selectEl.disabled = false;
          if (data.ok && displayEl) displayEl.textContent = label;
          else if (!data.ok) alert(data.error || 'Could not update card');
        })
        .catch(function() {
          selectEl.disabled = false;
          alert('Something went wrong — try again.');
        });
      }
      document.querySelectorAll('.account-payment-method-select').forEach(function(sel) {
        sel.addEventListener('change', function() { changeSubscriptionPaymentMethod(sel); });
      });

    })();
  </script>
</body>
</html>
