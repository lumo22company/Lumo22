<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Account | Lumo 22</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <meta name="description" content="Manage your Lumo 22 account: Digital Front Desk, Captions, and settings.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Encode+Sans+Condensed:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}?v={{ asset_version }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}?v={{ asset_version }}">
</head>
<body class="lumo-landing account-page-wrap">
  <nav class="lumo-nav" id="lumo-nav">
    <a href="/" class="lumo-nav-logo">Lumo 22</a>
    <div class="lumo-nav-links">
      <a href="/captions">Captions</a>
      <a href="/digital-front-desk">Front Desk</a>
    </div>
    <a href="/account" class="lumo-nav-cta">Account</a>
  </nav>

  <header class="account-hero">
    <div class="account-hero-inner">
      <div>
        <h1>Your account</h1>
        <p class="account-email">{{ customer.email }}</p>
        <p class="account-quick-links">
          <a href="/captions">Captions</a><span>·</span>
          <a href="/digital-front-desk">Front Desk</a>
        </p>
      </div>
      <form action="/api/auth/logout" method="POST" class="account-logout" style="margin: 0;">
        <button type="submit" class="dfd-btn dfd-btn-secondary">Log out</button>
      </form>
    </div>
  </header>

  {% if request.args.get('billing') == 'no_sub' %}
  <div class="account-section account-section--light">
    <div class="account-section-inner">
      <p class="account-alert account-alert--warn">No subscription found. If you're on the monthly plan, use the link in your order emails to manage billing.</p>
    </div>
  </div>
  {% elif request.args.get('billing') == 'error' %}
  <div class="account-section account-section--light">
    <div class="account-section-inner">
      <p class="account-alert account-alert--error">Could not open billing portal. Please try again or email hello@lumo22.com.</p>
    </div>
  </div>
  {% endif %}

  <section class="account-section account-section--light">
    <div class="account-section-inner">
      <h2 class="account-section-heading">Digital Front Desk</h2>
      {% if setups %}
        <div class="account-card-grid">
          {% for s in setups %}
          <div class="account-card">
            {% if (s.product_type or 'front_desk') == 'chat_only' %}
            <span class="account-badge account-badge-chat">Chat Assistant</span>
            {% else %}
            <span class="account-badge account-badge-dfd">Digital Front Desk</span>
            {% endif %}
            <h3 class="account-card-title">{{ s.business_name or 'Setup' }}</h3>
            <p class="account-card-meta">Enquiry email: {{ s.enquiry_email }}</p>
            {% if (s.product_type or 'front_desk') == 'front_desk' %}
            {% if s.forwarding_email %}
            <p class="account-card-meta">Forwarding: {{ s.forwarding_email }}</p>
            {% endif %}
            <div class="account-card-actions">
              <a href="/api/front-desk-setup/pause-auto-reply?token={{ s.done_token }}">Pause auto-reply</a>
              <a href="/api/front-desk-setup/resume-auto-reply?token={{ s.done_token }}">Resume auto-reply</a>
            </div>
            {% elif (s.product_type or '') == 'chat_only' and s.chat_widget_key %}
            <p class="account-card-meta">Embed code:</p>
            <pre class="embed-pre">&lt;script src="{{ base_url or '' }}/static/js/chat-widget.js" data-key="{{ s.chat_widget_key }}" async&gt;&lt;/script&gt;</pre>
            <p class="account-card-meta">Add this before the closing &lt;/body&gt; tag on your site.</p>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="account-empty">No Digital Front Desk setups yet.</p>
        <p class="account-empty" style="margin-top: 0.5rem;"><a href="/digital-front-desk#pricing">Get started</a></p>
      {% endif %}
    </div>
  </section>

  <section class="account-section account-section--dark">
    <div class="account-section-inner">
      <h2 class="account-section-heading">30 Days Captions</h2>
      {% set has_subscription = caption_orders and caption_orders|selectattr('stripe_customer_id')|list|length > 0 %}
      {% if has_subscription %}
      <p class="account-card-meta" style="margin-bottom: 1rem;">
        <a href="/api/billing/portal" style="color: var(--lum-gold); text-decoration: none;">Manage subscription</a> — update payment, view invoices, or cancel
      </p>
      {% endif %}
      {% if caption_orders %}
        <div class="account-card-grid">
          {% for o in caption_orders %}
          <div class="account-card">
            <span class="account-badge account-badge-captions">Order</span>
            <h3 class="account-card-title">Order {{ o.created_at[:10] if o.created_at else '' }}</h3>
            <p class="account-card-meta">Status: {{ o.status or '—' }}</p>
            {% if o.stripe_subscription_id %}
            <div class="account-settings-row" style="margin: 1rem 0 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
              <div>
                <div class="account-settings-label" style="font-size: 0.9rem;">Intake reminders</div>
                <div class="account-settings-desc" style="font-size: 0.85rem;">Email me before each pack so I can update my intake</div>
              </div>
              <div id="reminder-toggle-{{ o.id }}" role="button" tabindex="0" class="account-toggle {% if not o.reminder_opt_out %}on{% endif %}" aria-label="Toggle intake reminders" data-order-id="{{ o.id }}" onclick="toggleReminder(this)" onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleReminder(this); }"></div>
            </div>
            <div class="account-settings-row" style="margin: 0 0 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
              <div>
                <div class="account-settings-label" style="font-size: 0.9rem;">Pause subscription</div>
                <div class="account-settings-desc" style="font-size: 0.85rem;">{% if o.subscription_pause and o.subscription_pause.paused %}Paused — resumes {{ o.subscription_pause.resumes_at or 'automatically' }}{% else %}Pause billing for 1 month (no charge, no pack){% endif %}</div>
              </div>
              {% if o.subscription_pause and o.subscription_pause.paused %}
              <span class="account-pause-badge">Paused</span>
              {% else %}
              <button type="button" class="dfd-btn dfd-btn-secondary account-pause-btn" data-order-id="{{ o.id }}" onclick="pauseSubscription(this)">Pause for 1 month</button>
              {% endif %}
            </div>
            {% endif %}
            <div class="account-card-actions">
              {% if o.status == 'awaiting_intake' %}
              <a href="/captions-intake?t={{ o.token }}">Complete the form</a>
              {% else %}
              <a href="/captions-intake?t={{ o.token }}">Edit form</a>
              {% if o.status == 'delivered' %}
              <a href="/api/captions-download?t={{ o.token }}">Download captions</a>
              <a href="mailto:hello@lumo22.com">Contact us</a>
              {% else %}
              <a href="mailto:hello@lumo22.com">Contact us</a>
              {% endif %}
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="account-empty">No caption orders yet.</p>
        <p class="account-empty" style="margin-top: 0.5rem;"><a href="/captions">Get 30 Days Captions</a></p>
      {% endif %}
    </div>
  </section>

  <section class="account-section account-section--light">
    <div class="account-section-inner">
      <h2 class="account-section-heading">Settings</h2>
      <div class="account-settings-row">
        <div>
          <div class="account-settings-label">Marketing emails</div>
          <div class="account-settings-desc">Tips, updates, and offers from Lumo 22</div>
        </div>
        <div id="marketing-toggle-wrap" role="button" tabindex="0" class="account-toggle {% if customer.get('marketing_opt_in', True) %}on{% endif %}" aria-label="Toggle marketing emails" onclick="toggleMarketing()" onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleMarketing(); }"></div>
      </div>
    </div>
  </section>

  {% if referral_code %}
  <section class="account-section account-section--dark">
    <div class="account-section-inner">
      <h2 class="account-section-heading">Refer a friend</h2>
      <p class="account-card-meta" style="margin-bottom: 1rem;">Share your referral link — when friends sign up, they'll use your code.</p>
      <div class="referral-block">
        <label class="account-settings-label" for="referral-link">Your referral link</label>
        <div class="referral-row">
          <input type="text" id="referral-link" readonly value="{{ base_url }}/signup?ref={{ referral_code }}" class="referral-input">
          <button type="button" class="dfd-btn dfd-btn-secondary referral-copy" onclick="copyReferralLink()">Copy link</button>
        </div>
        <p class="account-settings-desc" style="margin-top: 0.5rem;">Or share your code: <strong>{{ referral_code }}</strong></p>
      </div>
    </div>
  </section>
  {% endif %}

  {% include '_footer.html' %}

  <script src="{{ url_for('static', filename='js/landing.js') }}?v={{ asset_version }}"></script>
  <script>
    (function() {
      document.querySelector('form[action="/api/auth/logout"]').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/api/auth/logout', { method: 'POST' })
          .then(function() { window.location.href = '/'; });
      });

      function toggleMarketing() {
        var wrap = document.getElementById('marketing-toggle-wrap');
        var optIn = wrap.classList.contains('on');
        var nextOptIn = !optIn;
        wrap.classList.toggle('on', nextOptIn);
        fetch('/api/auth/preferences', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ marketing_opt_in: nextOptIn })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.ok) { wrap.classList.toggle('on', optIn); }
        })
        .catch(function() { wrap.classList.toggle('on', optIn); });
      }

      function toggleReminder(el) {
        var wrap = el;
        var orderId = wrap.getAttribute('data-order-id');
        if (!orderId) return;
        var isOn = wrap.classList.contains('on');
        var nextOptOut = isOn;
        fetch('/api/captions/reminder-preference', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderId, reminder_opt_out: nextOptOut })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) wrap.classList.toggle('on', !nextOptOut);
        })
        .catch(function() {});
      }

      function copyReferralLink() {
        var input = document.getElementById('referral-link');
        if (!input) return;
        input.select();
        input.setSelectionRange(0, 99999);
        try {
          navigator.clipboard.writeText(input.value);
          var btn = document.querySelector('.referral-copy');
          if (btn) { btn.textContent = 'Copied!'; setTimeout(function() { btn.textContent = 'Copy link'; }, 2000); }
        } catch (e) {}
      }

      function pauseSubscription(btn) {
        var orderId = btn.getAttribute('data-order-id');
        if (!orderId) return;
        btn.disabled = true;
        btn.textContent = 'Pausing…';
        fetch('/api/captions/pause-subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderId })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            window.location.reload();
          } else {
            alert(data.error || 'Could not pause subscription');
            btn.disabled = false;
            btn.textContent = 'Pause for 1 month';
          }
        })
        .catch(function() {
          alert('Something went wrong — try again.');
          btn.disabled = false;
          btn.textContent = 'Pause for 1 month';
        });
      }
    })();
  </script>
</body>
</html>
