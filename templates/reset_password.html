<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset password | Lumo 22</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}?v={{ asset_version }}">
  <style>
    .auth-page { padding: 6rem 1.5rem 4rem; max-width: 420px; margin: 0 auto; }
    .auth-page h1 { font-family: var(--font-display); font-size: 1.75rem; margin-bottom: 0.5rem; }
    .auth-page .sub { color: var(--lum-text-muted); margin-bottom: 2rem; }
    .auth-page label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
    .auth-page input { width: 100%; padding: 0.75rem 1rem; background: var(--lum-surface-elevated); border: 1px solid var(--lum-border); border-radius: 8px; color: var(--lum-text); margin-bottom: 1.25rem; }
    .auth-page .btn { display: inline-block; padding: 1rem 2rem; background: var(--lum-gold); color: #000; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; width: 100%; }
    .auth-page .btn:hover { opacity: 0.95; }
    .auth-page .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .auth-page .msg { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.95rem; }
    .auth-page .msg.error { background: rgba(200,80,80,0.15); color: var(--lum-text); }
    .auth-page .msg.success { background: rgba(76,175,80,0.15); color: var(--lum-text); }
    .auth-page .link { margin-top: 1.5rem; text-align: center; }
    .auth-page .link a { color: var(--lum-gold); text-decoration: none; }
    .auth-page .link a:hover { text-decoration: underline; }
    .auth-page .no-token { padding: 1rem; background: rgba(200,80,80,0.15); border-radius: 8px; margin-bottom: 1.5rem; }
  </style>
</head>
<body class="lumo-landing">
  <nav class="lumo-nav lumo-nav-scrolled">
    <a href="/" class="lumo-nav-logo">Lumo 22</a>
    <div class="lumo-nav-links">
      <a href="/captions">Captions</a>
    </div>
    <a href="/login" class="lumo-nav-cta lumo-nav-login">Log in</a>
  </nav>

  <main class="auth-page">
    <h1>Reset password</h1>
    <p class="sub">Enter your new password below. Links expire after 1 hour.</p>

    {% if not token %}
    <p class="no-token">No reset token found. Please use the link from your email, or <a href="/forgot-password">request a new one</a>.</p>
    {% else %}
    <form id="reset-form">
      <input type="hidden" id="token" name="token" value="{{ token }}">
      <label for="password">New password</label>
      <input type="password" id="password" name="password" required autocomplete="new-password" minlength="6" placeholder="At least 6 characters">

      <label for="password2">Confirm new password</label>
      <input type="password" id="password2" name="password2" required autocomplete="new-password" minlength="6">

      <button type="submit" class="btn" id="btn">Set new password</button>
      <div id="msg" class="msg" style="display: none;"></div>
    </form>
    {% endif %}

    <p class="link"><a href="/login">← Back to log in</a></p>
  </main>

  {% if token %}
  <script>
    (function() {
      var form = document.getElementById('reset-form');
      var btn = document.getElementById('btn');
      var msg = document.getElementById('msg');

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var pw = document.getElementById('password').value;
        var pw2 = document.getElementById('password2').value;
        if (pw !== pw2) {
          msg.className = 'msg error';
          msg.textContent = 'Those passwords don\'t match.';
          msg.style.display = 'block';
          return;
        }
        if (pw.length < 6) {
          msg.className = 'msg error';
          msg.textContent = 'Just need at least 6 characters.';
          msg.style.display = 'block';
          return;
        }

        msg.style.display = 'none';
        btn.disabled = true;
        btn.textContent = 'Updating…';

        fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: document.getElementById('token').value, password: pw })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            msg.className = 'msg success';
            msg.textContent = data.message || 'Password updated. Taking you to log in…';
            msg.style.display = 'block';
            setTimeout(function() { window.location.href = '/login'; }, 2000);
          } else {
            msg.className = 'msg error';
            msg.textContent = data.error || 'That link may have expired. Request a new one from the log in page.';
            msg.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Set new password';
          }
        })
        .catch(function() {
          msg.className = 'msg error';
          msg.textContent = 'Something didn\'t send — try again.';
          msg.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Set new password';
        });
      });
    })();
  </script>
  {% endif %}
  {% include '_footer.html' %}
</body>
</html>
